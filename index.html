<!DOCTYPE html>
<html lang="id">
<head>
<!-- Deploy note: put your GeoJSON files in /data and images in /assets when hosting on GitHub Pages. -->

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Traffic Monitoring System for Public Safety</title>

<link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
if (window.Chart) {
  Chart.defaults.color = '#fff';
  Chart.defaults.borderColor = 'rgba(255,255,255,0.2)';
  Chart.defaults.plugins.legend.labels.color = '#fff';
  Chart.defaults.plugins.legend.labels.boxWidth = 10;
  Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0,0,0,0.85)';
  Chart.defaults.plugins.tooltip.titleColor = '#fff';
  Chart.defaults.plugins.tooltip.bodyColor  = '#fff';
}
</script>

<style>
  :root {
    --panel-bg: rgba(255,255,255,0.98);
    --accent: #1a237e; /* biru header */
    --shadow: 0 8px 26px rgba(0,0,0,0.12);
    --divider: #e9eef5;
  }
  html,body { height:100%; margin:0; font-family:'Fira Sans', Arial, sans-serif; background:#f5f7fb; }
  #map { position:absolute; inset:0; }

  #main-header { position:fixed; top:0; left:0; right:0; height:40px; background:var(--accent); color:#fff; display:none; align-items:center; justify-content:center; z-index:1600; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
  #main-header h1 { font-size:16px; margin:0; font-weight:600; }

  #filter-screen { position:absolute; inset:0; background:rgba(0,0,0,0.65); display:flex; align-items:center; justify-content:center; z-index:1700; }
  #splash-container {
  width: 100%;
  height: 100%;
  display: flex;
  border-radius: 0;                /* opsional: hilangkan rounded agar benar2 full */
  overflow: hidden;
  box-shadow: none;                /* opsional: hilangkan bayangan */
}
  #splash-left { flex:0 0 30%; max-width: 30%; background:linear-gradient(180deg,#12203a,#0b2540); color:#fff; padding:40px; display:flex; flex-direction: column; align-items:center; justify-content:center; text-align:center; }
  #splash-left h2 { margin:0; font-size:24px; line-height:1.3; font-weight:700; }
  #splash-right {
    flex: 0 0 70%;
    max-width: 70%;
    background: #0b2540;   /* latar saat peta loading */
    padding: 0;
    position: relative;
  }
  #splash-right h3 { margin:0; font-size:22px; font-weight:600; }
  #splash-right p { font-size:14px; color:rgba(255,255,255,0.8); margin:4px 0 12px 0; }
  .btn-primary { background:#ffc107; color:#000; border:0; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:700; transition:background-color .2s; }
  .btn-primary:hover { background:#ffd966; }
  select { padding:10px; border-radius:6px; border:1px solid rgba(0,0,0,0.12); font-size:14px; text-align:center; }
  /* Kontainer peta di panel kanan */
  #splash-map {
    position: absolute;
    inset: 0;             /* full di dalam #splash-right */
  }

  /* Gaya callout/label Satwil di peta awal */
  #splash-right .maplibregl-popup { margin-bottom: 0 !important; }
  #splash-right .maplibregl-popup-content {
    position: relative;
    background: #1a237e !important;
    color: #fff;
    border: 2px solid #ffc107 !important;
    border-radius: 12px !important;
    font-weight: 700;
    font-size: 12px;
    line-height: 1.2;
    text-align: center;
    padding: 6px 10px;
    white-space: normal;
    overflow-wrap: anywhere;
    box-shadow: 0 3px 8px rgba(0,0,0,0.25) !important;
    cursor: pointer;
  }

  /* Buat bagian “segitiga” bawah seperti jarum pin */
  #splash-right .maplibregl-popup-content::after {
    content: "";
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 8px solid #1a237e;
  }

  /* Hilangkan default segitiga bawaan MapLibre */
  #splash-right .maplibregl-popup-tip {
    display: none !important;
  }
  #splash-right .maplibregl-popup-content {
    animation: pin-pop 0.3s ease-out;
  }

  @keyframes pin-pop {
    from { transform: scale(0.6) translateY(10px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }

  #filter-panel {
    position:absolute; top:52px; left:50%; transform:translateX(-50%);
    z-index:1500; background:var(--accent); padding:10px 14px;
    border-radius:12px; box-shadow:var(--shadow);
    display:none; align-items:center; gap:10px;
  }
  #filter-panel label { font-weight:600; color: #ffc107; }

  #bottom-panel-wrapper { position:absolute; bottom:12px; left:50%; transform:translateX(-50%); z-index:1500; display:none; }
  #bottom-panel { width:360px; background:var(--panel-bg); border-radius:12px; box-shadow:var(--shadow); overflow:hidden; transition:all .3s ease; }
  #panel-header { display:flex; justify-content:space-between; align-items:center; padding:4px 8px; border-bottom:1px solid rgba(0,0,0,0.08); }
  #bottom-panel.minimized #panel-header { cursor:pointer; }
  #panel-tabs { display:flex; gap:4px; }
  .panel-tab-btn { display:flex; align-items:center; gap:6px; background:transparent; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; color:#555; transition:.2s; }
  .panel-tab-btn svg { width:18px; height:18px; fill:#555; transition:fill .2s; }
  .panel-tab-btn:hover { background:rgba(0,0,0,0.05); }
  .panel-tab-btn.active { background:var(--accent); color:#fff; }
  .panel-tab-btn.active svg { fill:#fff; }
  #panel-controls .min-btn { font-size:20px; width:32px; height:32px; border-radius:8px; }
  #panel-body { padding:12px 14px; max-height:400px; overflow-y:auto; transition:all .3s ease; }
  .panel-content { display:none; }
  .panel-content.active { display:block; }
  .panel-content h4 { margin:0 0 10px 0; font-size:15px; font-weight:600; }
  .legend-item { display:flex; gap:10px; align-items:center; margin-bottom:8px; }
  .legend-icon { width:36px; height:24px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .legend-label { font-size:13px; color:#222; }
  .legend-title { font-size:14px; margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:4px; font-weight:bold; }
  .legend-title:not(:first-child){ margin-top:12px; }

  .tab-control-group { display: flex; flex-direction: column; gap: 6px; }
  .tab-btn { width: 100%; padding: 8px; font-size: 14px; font-weight: 600; text-align: left; border: 1px solid #ddd; background-color: #f8f9fa; color: #333; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
  .tab-btn:hover { background-color: #e9ecef; border-color: #ccc; }
  .tab-btn.active { background-color: var(--accent); color: #fff; border-color: var(--accent); }

  .min-btn { background:transparent; border:0; font-size:16px; cursor:pointer; color:var(--accent); }
  .min-btn:hover { background:rgba(0,0,0,0.05); }
  #controls-bl { position:absolute; left:12px; bottom:12px; z-index:1500; display:none; flex-direction:column; gap:8px; align-items:flex-start; pointer-events:none; }
  #zoom-compass { display:flex; gap:8px; align-items:center; pointer-events:auto; }
  #zoom-controls { display:flex; flex-direction:column; background:var(--panel-bg); border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); overflow:hidden; }
  .zoom-btn { width:40px; height:36px; border:0; background:transparent; cursor:pointer; font-size:18px; color:#222; }
  #compass { width:46px; height:46px; background:var(--panel-bg); border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
  #my-location-btn { width: 46px; height: 46px; background: var(--panel-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
  #my-location-btn:hover { background: #e9eef5; }
  #scale-box { background:var(--panel-bg); border-radius:8px; padding:6px 8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); pointer-events:auto; }
  .maplibregl-popup-content { font-family:'Fira Sans', sans-serif; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); padding:0; max-width:280px!important; }
  .maplibregl-popup-close-button { font-size:20px; color:#fff; background:rgba(0,0,0,0.2); border-radius:50%; width:24px; height:24px; margin:6px 6px 0 0; line-height:24px; text-align:center; }
  .popup-header { background:var(--accent); color:#fff; padding:8px 36px 8px 12px; font-weight:600; font-size:15px; border-top-left-radius:8px; border-top-right-radius:8px; }
  .popup-body { padding:10px 12px; font-size:13px; max-height:180px; overflow-y:auto; }
  .popup-body strong { color:#333; }

  /* === Gaya untuk Time Slider Panel === */

  #time-slider-wrapper {
    position: absolute;
    top: 115px; /* Diturunkan sedikit agar tidak menempel */
    left: 50%;
    transform: translateX(-50%);
    z-index: 1500;
    display: none; /* Awalnya disembunyikan, diatur oleh JS */
  }

  #time-slider-panel {
    background: var(--accent);
    padding: 10px 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    display: flex; /* Diubah menjadi flex */
    flex-direction: column; /* Arahnya ke bawah */
    color: #fff;
    font-size: 13px;
    font-weight: 600;
  }

  #time-slider-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  #time-slider-header h4 {
    margin: 0;
    font-size: 14px;
  }

  #time-slider-header .min-btn {
    color: #fff; /* Pastikan tombol '−' berwarna putih */
  }

  #time-slider-body {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  #time-slider-minimized-btn {
    display: none; /* Awalnya disembunyikan */
    font-size: 14px;
    font-weight: 700;
    border: 3px solid #1a237e;
    border-radius: 12px;
  }

  #slider-container {
    position: relative;
    width: 350px;
  }

  #time-slider {
    width: 100%;
    -webkit-appearance: none;
    appearance: none;
    height: 5px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 5px;
    outline: none;
    cursor: pointer;
  }

  /* Style untuk thumb (bulatan slider) */
  #time-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #ffc107;
    border: 3px solid #fff;
    border-radius: 50%;
    cursor: pointer;
  }

  #time-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #ffc107;
    border: 3px solid #fff;
    border-radius: 50%;
    cursor: pointer;
  }

  /* Style untuk Tooltip Tanggal */
  #slider-tooltip {
    position: absolute;
    background: #000;
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    bottom: 30px; /* Di atas slider */
    transform: translateX(-50%);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
  }

  /* =================== DASHBOARD (DARK BLUE THEME) =================== */
  #dashboard-panel {
    --dash-bg:#1a237e; --dash-bg-2:#151b6d; --dash-fg:#ffffff; --dash-subtle:#eeeeee; --dash-divider:rgba(255,255,255,0.3);
    position:absolute; top:52px; right:12px; width:320px; z-index:1500; background:var(--dash-bg);
    border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.4); display:none; flex-direction:column; color:var(--dash-fg);
  }
  #dashboard-header { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-bottom:1px solid var(--dash-divider); background:var(--dash-bg-2); }
  #dashboard-header .min-btn { color: #fff; }
  #dashboard-header h4 { margin:0; font-size:15px; color:var(--dash-fg); }
  #dashboard-body { padding:12px; max-height:calc(100vh - 120px); overflow-y:auto; display:flex; flex-direction:column; gap:8px; line-height:1.25; word-break:break-word; }

  .dash-item-container + .dash-item-container { border-top: 1px solid var(--dash-divider); margin-top: 8px; padding-top: 8px; }
  .dash-item-header { display: flex; justify-content: space-between; align-items: center; padding: 0 4px 8px 4px; cursor: pointer; }
  .dash-item-header h5 { margin: 0; font-size: 13px; text-align: center; color: var(--dash-fg); flex: 1; padding-left: 24px; }
  .dash-item-body { position: relative; overflow: hidden; height: 202px; }
  .dash-item-body.doughnut { height: 162px; }
  .dash-item-container.list .dash-item-body { height: auto; min-height: 50px; }
  .dash-item-container.minimized .dash-item-body { display: none; }
  .dash-item-toggle { color: var(--dash-fg); background-color: transparent; border: none; font-size: 20px; padding: 0 8px; cursor: pointer; }
  .dash-item-toggle:hover { background: rgba(255,255,255,0.1); border-radius: 4px; }
  
  .blackspot-list-item { display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid var(--dash-divider); font-size:13px; }
  .blackspot-list-item:last-child{ border-bottom:0; }
  .blackspot-list-item .score{ font-weight:700; background:#ff5252; color:#fff; padding:2px 6px; border-radius:4px; font-size:12px; }
  .no-data-info{ font-size:13px; color:var(--dash-subtle); text-align:center; padding:12px 0; }
  .note-info{ margin-top:6px; font-size:12px; color:var(--dash-subtle); text-align:center; }
  
  /* =================== SEARCH & ROUTING PANEL (kiri atas) =================== */
  #search-routing-panel {
    position:absolute; top:52px; left:12px; z-index:1501; background:#1a237e; color:#fff;
    border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,0.4); padding:10px; width:300px;
    display:none; flex-direction:column; gap:10px;
  }
  #search-routing-panel h4 { margin:0; font-size:14px; }
  .field-wrap { position:relative; width:100%; }
  .field-wrap input, .field-wrap select { width:100%; padding:8px; border:none; border-radius:6px; outline:none; font-family:'Fira Sans'; font-size:13px; box-sizing: border-box; }
  .field-wrap input { background:#fff; color:#000; }
  .dropdown-results { position:absolute; left:0; right:0; top:calc(100% + 6px); z-index: 10; background:#fff; color:#000; border-radius:6px; max-height:220px; overflow-y:auto; display:none; font-size:13px; box-shadow:0 4px 10px rgba(0,0,0,0.25); }
  .dropdown-results .result-item { padding:6px 8px; cursor:pointer; border-bottom:1px solid #eee; }
  .dropdown-results .result-item:hover { background:#e3f2fd; }

  #mode-tabs { display: flex; gap: 6px; width: 100%; }
  .mode-tab-btn { flex: 1; padding: 8px; font-size: 13px; font-weight: 600; border: 1px solid rgba(255,255,255,0.3); background-color: transparent; color: #fff; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
  .mode-tab-btn:hover { background-color: rgba(255,255,255,0.1); }
  .mode-tab-btn.active { background-color: #ffc107; color: #000; border-color: #ffc107; }

  #route-controls { display:flex; flex-direction:column; background:rgba(255,255,255,0.1); border-radius:8px; padding:8px; transition: all 0.3s ease; }
  #route-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; margin-bottom: 8px; }
  #route-body { display:flex; flex-direction:column; gap:6px; transition: all 0.3s ease; }
  #route-controls.minimized #route-header { margin-bottom: 0; }
  #route-controls.minimized #route-body { display:none; }
  #route-controls small { color:#e0e0ff; }
  #route-controls .row { display:flex; gap:6px; align-items:center; }
  #route-results { background:rgba(0,0,0,0.28); border-radius:6px; font-size:13px; overflow:hidden; }
  #route-results-header{ display:flex; align-items:center; justify-content:space-between; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,0.2); }
  #route-results-body{ max-height:180px; overflow-y:auto; padding:6px 8px; transition:max-height .2s ease; }
  #route-results.collapsed #route-results-body{ max-height:0; padding:0 8px; }
  
  .btn { background:#ffc107; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; font-weight:700; color:#000; }
  .btn:hover { background:#ffeb3b; }
  
  /* ====== GAYA BARU: POPUP PERINGATAN RUTE ====== */
  #route-alert-popup {
    position: absolute;
    top: 52px;
    left: 322px; /* 12px (panel left) + 300px (panel width) + 10px (gap) */
    z-index: 1502;
    background: #fff3cd;
    border: 1px solid #ffeeba;
    border-left: 5px solid #ffc107;
    color: #856404;
    padding: 12px 30px 12px 15px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    max-width: 280px;
    font-size: 14px;
    font-weight: 600;
    line-height: 1.4;
    display: none; /* Awalnya disembunyikan */
    animation: slide-in 0.4s ease-out;
  }
  #route-alert-popup .close-btn {
    position: absolute;
    top: 2px;
    right: 5px;
    font-size: 24px;
    font-weight: bold;
    color: #856404;
    cursor: pointer;
    border: none;
    background: none;
    padding: 4px;
    line-height: 1;
  }
  @keyframes slide-in {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  #btn-swap-route {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: transparent;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: background-color 0.2s;
  }
  #btn-swap-route:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  /* ====== LOADING OVERLAY (IMAGE PULSE) ====== */
  #loading-overlay {
    position:fixed; inset:0; background:rgba(26, 35, 126, 0.9);
    display:none; align-items:center; justify-content:center;
    z-index:9999; color:#fff; flex-direction:column; gap:20px;
    font-size: 16px; font-weight: 600;
  }
  .loading-logo { width: 120px; height: auto; animation: pulse 1.5s infinite ease-in-out; }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

  /* ====== MEASUREMENT TOOLS ====== */
  #measure-panel { background: var(--panel-bg); border-radius: 8px; box-shadow: var(--shadow); padding: 8px; pointer-events: auto; transition: all 0.3s ease; }
  #measure-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  #measure-header h4 { font-size: 14px; margin: 0; color: #333; }
  #measure-header span { font-size: 14px; font-weight: 600; color: #333; }
  #measure-panel .min-btn { color: var(--accent); }
  #measure-panel.minimized { padding: 4px 8px; }
  #measure-panel.minimized #measure-body, #measure-panel.minimized #measure-title-expanded { display: none; }
  #measure-panel:not(.minimized) #measure-title-minimized { display: none; }
  #measure-body { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
  #measure-controls { display: flex; gap: 6px; }
  .measure-btn { flex: 1; padding: 6px 8px; font-size: 13px; font-weight: 600; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; }
  .measure-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .measure-btn#btn-measure-clear { flex: 0 0 auto; background-color: #fbe9e7; color: #c62828; }
  #measure-result { font-size: 13px; text-align: center; color: #333; font-weight: 600; background: #f1f3f5; padding: 6px; border-radius: 6px; }

  @media (max-width:720px) {
    #splash-container { width:92%; flex-direction:column; }
    #splash-right { width:100%; }
    #bottom-panel-wrapper { width:95%; }
    #dashboard-panel { display:none!important; }
    #measure-panel { display: none !important; }
  }

  #splash-right .maplibregl-popup {
    margin-bottom: 0 !important;
  }

  #splash-right .maplibregl-popup-content {
    position: relative;
    background: #1a237e;       /* warna biru */
    color: #fff;
    border: 2px solid #ffc107; /* outline kuning */
    border-radius: 12px;
    font-weight: 700;
    font-size: 12px;
    line-height: 1.3;
    text-align: center;
    padding: 8px 12px;
    white-space: normal;
    overflow-wrap: anywhere;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    cursor: pointer;
  }

  /* segitiga bawah (pin) */
  #splash-right .maplibregl-popup-content::after {
    content: "";
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 10px solid #1a237e;
  }

  /* hilangkan bawaan MapLibre */
  #splash-right .maplibregl-popup-tip {
    display: none !important;
  }

  /* animasi muncul */
  @keyframes pin-pop {
    from { transform: scale(0.5) translateY(10px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }
  #splash-right .maplibregl-popup-content {
    animation: pin-bounce 2.2s cubic-bezier(0.28, 0.84, 0.42, 1) infinite;
    transform-origin: bottom center;
  }

  /* Keyframes untuk gerakan bounce halus */
  @keyframes pin-bounce {
    0%, 100% {
      transform: translateY(0);
    }
    20% {
      transform: translateY(-6px);
    }
    40% {
      transform: translateY(0);
    }
    60% {
      transform: translateY(-3px);
    }
    80% {
      transform: translateY(0);
    }
  }

  /* === Kotak Outline di Panel Kiri (Splash Left) === */
  #splash-left {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Gaya Baru untuk Panel Kiri di Tampilan Awal */
  #splash-left {
      display: flex; /* Aktifkan flexbox */
      flex-direction: column; /* Susun item secara vertikal */
      justify-content: center; /* Tengahkan konten secara vertikal */
      align-items: center; /* Tengahkan konten secara horizontal */
      padding: 0 20px; /* Tambahkan padding samping */
      /* Hapus padding-top karena sudah di-justify-content: center */
  }

  #splash-left-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 380px;
  }

  #splash-logo {
      width: 200px; /* Perkecil logo sedikit */
      height: auto;
      margin-bottom: 5px;
  }

  #splash-title {
      color: #333; /* Ubah warna teks menjadi gelap karena latar belakang card putih */
      margin: 0; /* Hapus margin bawah karena card sudah punya padding */
      font-size: 20px;
      line-height: 1.3;
  }

  #splash-chart-container {
      width: 100%;
      height: 200px; /* Tentukan tinggi wadah grafik */
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 20px;
  }

  #splash-left .info-card {
    background-color: white;
    padding: 20px 30px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    text-align: center;
    width: 100%;
    max-width: 380px; /* Lebar card */
    margin-bottom: 25px; /* Jarak antara card dan chart */
    display: flex; /* Menggunakan flexbox untuk vertikal center */
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
  #splash-left {
    position: relative;
  }

  #splash-left .corner-header {
    position: absolute;
    top: 20px;
    left: 20px;
    display: flex;                /* sejajarkan logo & teks */
    align-items: center;          /* vertikal rata tengah */
    flex-direction: row;          /* pastikan sejajar ke kanan */
    gap: 10px;                    /* jarak antar elemen */
    z-index: 10;
  }

  /* Logo Korlantas */
  #splash-left .corner-header .corner-logo {
    width: 60px;
    height: auto;
    flex-shrink: 0;
    opacity: 0.95;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  #splash-left .corner-header .corner-logo:hover {
    transform: scale(1.05);
    opacity: 1;
  }

  /* Teks di sebelah kanan logo */
  #splash-left .corner-header .corner-text {
    color: #ffffff;
    font-size: 17.5px;
    line-height: 1.25;
    font-weight: 600;
    text-align: left;
    max-width: 180px;
  }

  /* Responsif di layar kecil */
  @media (max-width: 720px) {
    #splash-left .corner-header {
      top: 10px;
      left: 10px;
      gap: 6px;
    }

    #splash-left .corner-header .corner-logo {
      width: 50px;
    }

    #splash-left .corner-header .corner-text {
      font-size: 11px;
      max-width: 160px;
    }
  }

  #splash-left .info-subtext {
    margin-top: 16px;
    color: #ffffff;        /* biru sesuai tema */
    font-size: 16px;
    font-weight: 500;
    text-align: center;
    opacity: 0.9;
    max-width: 300px;
    line-height: 1.4;
  }

  /* Responsif */
  @media (max-width: 720px) {
    #splash-left .info-subtext {
      font-size: 13px;
      margin-top: 12px;
      max-width: 260px;
    }
  }
  #splash-left .info-subtext {
    animation: fadein-subtext 0.8s ease-out 0.3s both;
  }

  @keyframes fadein-subtext {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Gaya untuk Teks "Last Update" */
  #splash-last-update {
    width: 100%;  
    font-style: italic;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    margin: -10px 0 10px 0; /* Margin atas negatif agar lebih dekat ke grafik */
    text-align: right;
    height: 16px; /* Beri tinggi agar layout tidak bergeser saat teks muncul */
  }

  /* Gaya untuk Copyright Footer */
  #copyright-footer {
      position: absolute;
      bottom: 15px;
      left: 20px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
  }

  .route-option-btn {
    width: 100%;
    padding: 8px;
    font-size: 13px;
    font-weight: 600;
    text-align: left;
    border: 1px solid rgba(255,255,255,0.4);
    background-color: transparent;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .route-option-btn:hover {
    background-color: rgba(255,255,255,0.1);
  }
  .route-option-btn.active {
    background-color: #ffc107;
    color: #000;
    border-color: #ffc107;
  }
  .route-option-btn span {
    font-size: 11px;
    opacity: 0.8;
  }

  /* === Gaya untuk Animasi Border Berjalan === */

  #splash-left-content {
    position: relative; /* Penting agar elemen 'absolute' di dalamnya terkunci */
    padding: 15px 45px; /* Beri sedikit ruang agar garis tidak terlalu mepet */
  }

  .border-line {
    position: absolute;
    background-color: #ffc107; /* Warna garis kuning seperti grafik */
    box-shadow: 0 0 5px #ffc107, 0 0 10px #ffc107; /* Efek glow */
  }

  /* Posisi dan ukuran awal setiap garis */
  .line-top {
    top: 0;
    left: 0;
    width: 0;
    height: 2px;
  }
  .line-right {
    top: 0; 
    right: 0;
    width: 2px;
    height: 0;
  }
  .line-bottom {
    bottom: 0;
    right: 0;
    width: 0;
    height: 2px;
  }
  .line-left {
    bottom: 0;
    left: 0;
    width: 2px;
    height: 0;
  }

  /* Mendefinisikan animasi untuk setiap garis */
  @keyframes animate-top {
    25% { width: 100%; }
    100% { width: 100%; }
  }
  @keyframes animate-right {
    25% { height: 0; }
    50% { height: 100%; }
    100% { height: 100%; }
  }
  @keyframes animate-bottom {
    50% { width: 0; }
    75% { width: 100%; }
    100% { width: 100%; }
  }
  @keyframes animate-left {
    75% { height: 0; }
    100% { height: 100%; }
  }

  /* Menerapkan animasi ke setiap garis dengan durasi total 4 detik, berulang */
  .line-top {
    animation: animate-top 4s linear infinite;
  }
  .line-right {
    animation: animate-right 4s linear infinite;
  }
  .line-bottom {
    animation: animate-bottom 4s linear infinite;
  }
  .line-left {
    animation: animate-left 4s linear infinite;
  }

  /* Gaya untuk Tombol Berita di Splash Screen */
  .btn-splash-news {
      background: #ffc107;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 700;
      color: #000;
      text-decoration: none; /* Menghilangkan garis bawah dari link */
      display: inline-block; /* Agar padding dan margin berfungsi dengan baik */
      margin-top: 15px; /* Memberi jarak dari teks "Last Update" */
      transition: background-color 0.2s;
  }

  .btn-splash-news:hover {
      background: #ffeb3b; /* Efek hover yang sama dengan tombol lain */
  }

  /* === Gaya untuk Tombol & Petunjuk di Splash Right === */

  #btn-show-hint {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 15px;
      border-radius: 8px;
      border: 2px solid rgba(26, 35, 126, 0.9);
      z-index: 10; /* Pastikan tombol di atas peta */
  }

  #hint-text-overlay {
      position: absolute;
      top: 80px; /* Di bawah tombol */
      left: 20px;
      background: rgba(26, 35, 126, 0.9);
      color: #fff;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid #ffc107;
      font-weight: 600;
      font-size: 14px;
      z-index: 10;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none; /* Agar tidak bisa diklik */
  }

  #hint-text-overlay.visible {
      opacity: 1;
      transform: translateY(0);
  }

  /* Animasi Denyut untuk Highlight Pin */
  @keyframes pulse-glow {
      0% {
          transform: scale(1);
          box-shadow: 0 0 5px #ffc107, 0 0 10px #ffc107, 0 0 15px #ffc107;
      }
      50% {
          transform: scale(1.1);
          box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #ffc107;
      }
      100% {
          transform: scale(1);
          box-shadow: 0 0 5px #ffc107, 0 0 10px #ffc107, 0 0 15px #ffc107;
      }
  }

  /* Kelas sementara yang akan ditambahkan ke pin */
  .highlight-pin .maplibregl-popup-content {
      animation: pulse-glow 1.5s ease-in-out 2; /* Ulangi animasi 2 kali */
  }

</style>
</head>
<body>

<header id="main-header"><h1>Smart Traffic Monitoring System for Public Safety</h1></header>

<div id="loading-overlay">
  <img src="assets/korlantas25.png" alt="Memuat..." class="loading-logo" />
  <span>Memuat Peta & Data...</span>
</div>

<div id="filter-screen">
  <div id="splash-container">
    <div id="splash-left">
        <div class="corner-header">
            <img src="assets/korlantas25.png" alt="Logo Korlantas" class="corner-logo" />
            <span class="corner-text">
                Korps Lalu Lintas<br>
                Kepolisian Negara Republik Indonesia
            </span>
        </div>

        <div id="splash-left-content">
            <span class="border-line line-top"></span>
            <span class="border-line line-right"></span>
            <span class="border-line line-bottom"></span>
            <span class="border-line line-left"></span>
            <div class="info-card"> 
                <img src="assets/logo_STMSPS.png" alt="Logo STMSPS" id="splash-logo" />
                <h2 id="splash-title">Smart Traffic Management System for Public Safety</h2>
            </div>

            <div id="splash-chart-container">
                <canvas id="splash-troublespot-chart"></canvas>
            </div>

            <p id="splash-last-update"></p>
            <a href="https://www.detik.com/tag/kecelakaan" target="_blank" class="btn-splash-news">Jelajahi Berita Kecelakaan</a>
        </div>

        <div id="copyright-footer">Copyright ©2025 Elang Strategi Adidaya (ESTRADA) | All Rights Reserved</div>
    </div>
    <div id="splash-right">
      <button id="btn-show-hint" class="btn-splash-news">Jelajahi Peta</button>

      <div id="hint-text-overlay" class="hidden">
          <span>Pilih salah satu Satwil untuk menjelajahi peta lebih lanjut</span>
      </div>
      <svg id="arrow-overlay" class="hidden"></svg>
      <!-- Peta pemilihan Satwil -->
      <div id="splash-map" aria-label="Peta pilih Satwil"></div>
    </div>
  </div>
</div>

<div id="map"></div>

<div id="search-routing-panel">
  <div class="field-wrap" id="search-box">
    <input id="search-input" type="text" placeholder="Cari tempat atau nama feature..." />
    <div id="search-results" class="dropdown-results"></div>
  </div>
  
  <div id="route-controls" class="minimized">
    <div id="route-header">
       <h4>Pencarian Rute</h4>
       <button id="btn-toggle-route" class="btn" style="padding:4px 8px;">Buka</button>
    </div>
    <div id="route-body">
      <div class="row" style="justify-content:space-between;">
        <small>Aktifkan untuk pilih titik via klik peta (klik pertama untuk Lokasi Asal, klik kedua untuk Lokasi Tujuan)</small>
      </div>
      <div class="row">
        <label style="display:flex; align-items:center; gap:6px; font-size:13px;">
          <input type="checkbox" id="click-pick-toggle" />
          <span>Pilih titik via klik peta</span>
        </label>
      </div>
      <div style="display: flex; align-items: center; gap: 8px;">
        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 6px;">
          <div class="field-wrap">
            <input id="from-input" placeholder="Lokasi Asal (ketik atau klik peta)" />
            <div id="from-results" class="dropdown-results"></div>
          </div>
          <div class="field-wrap">
            <input id="to-input" placeholder="Lokasi Tujuan (ketik atau klik peta)" />
            <div id="to-results" class="dropdown-results"></div>
          </div>
        </div>
        <button id="btn-swap-route" title="Tukar Lokasi">
          <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor">
            <path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/>
          </svg>
        </button>
      </div>
      <div id="mode-tabs">
        <button class="mode-tab-btn active" data-mode="car">Mobil 🚗</button>
        <button class="mode-tab-btn" data-mode="bicycle">Sepeda 🚲</button>
        <button class="mode-tab-btn" data-mode="foot">Jalan Kaki 🚶</button>
      </div>
      <div class="row">
        <button id="btn-route" class="btn" style="flex:1;">Tampilkan Rute</button>
        <button id="btn-clear-route" class="btn" style="flex:0 0 auto;">Reset Rute</button>
      </div>
    </div>
  </div>

  <div id="route-results" style="display: none;">
    <div id="route-results-header">
      <div style="font-weight:700">Hasil Arah Rute</div>
      <button id="btn-collapse-route" class="btn" style="padding:4px 8px;">Tutup</button>
    </div>
    <div id="route-options-container" style="padding: 6px 8px; display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid rgba(255,255,255,0.2);">
    </div>
    <div id="route-results-body"></div>
  </div>
</div> <div id="route-alert-popup" style="display:none;"></div>

<div id="filter-panel">
  <label>Satwil</label>
  <select id="wilayah-select" aria-label="Ganti Satwil">
    <option value="" disabled selected hidden>Pilih Satwil</option>
  </select>
  <button id="btn-ganti" class="btn-primary" style="padding:8px 10px; font-size:13px;">Ganti</button>
</div>

<div id="time-slider-wrapper">
  <div id="time-slider-panel">
    <div id="time-slider-header">
      <h4>Sebaran Lokasi Black Spot Selama 7 Hari Terakhir</h4>
      <button id="time-slider-toggle-btn" class="min-btn" title="Minimize">−</button>
    </div>
    <div id="time-slider-body">
      <label id="slider-label-start">Tanggal Awal</label>
      <div id="slider-container">
        <input type="range" id="time-slider" min="0" max="100" value="100">
        <div id="slider-tooltip"></div>
      </div>
      <label id="slider-label-end">Tanggal Akhir</label>
    </div>
  </div>

  <button id="time-slider-minimized-btn" class="btn">Informasi Temporal Black Spot</button>
</div>

<div id="dashboard-panel">
  <div id="dashboard-header">
    <h4>Grafik Statistik</h4>
    <button id="dashboard-minimize-btn" class="min-btn" title="Minimize">−</button>
  </div>
  <div id="dashboard-body">
    <div class="dash-item-container">
      <div class="dash-item-header">
        <h5>Jumlah Troublespot</h5>
        <button class="dash-item-toggle min-btn">−</button>
      </div>
      <div class="dash-item-body">
        <canvas id="troublespot-chart"></canvas>
      </div>
    </div>
    <div class="dash-item-container">
      <div class="dash-item-header">
        <h5>Status CCTV</h5>
        <button class="dash-item-toggle min-btn">−</button>
      </div>
      <div class="dash-item-body doughnut">
        <canvas id="cctv-chart"></canvas>
      </div>
    </div>
    <div class="dash-item-container list">
      <div class="dash-item-header">
        <h5>Top 5 Black Spot</h5>
        <button class="dash-item-toggle min-btn">−</button>
      </div>
      <div class="dash-item-body">
        <div id="blackspot-list"></div>
        <div id="blackspot-note" class="note-info"></div>
      </div>
    </div>
  </div>
</div>

<div id="bottom-panel-wrapper">
  <div id="bottom-panel" class="minimized">
    <div id="panel-header">
      <div id="panel-tabs">
        <button class="panel-tab-btn active" data-content="basemap-content">
          <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5-10-5-10 5zM2 12l10 5 10-5-10-5-10 5z"/></svg>
          <span>Basemap</span>
        </button>
        <button class="panel-tab-btn" data-content="layer-content">
          <svg viewBox="0 0 24 24"><path d="M12 16.5l-7-4.5 7-4.5 7 4.5-7 4.5zM12 2L2 7l10 5 10-5L12 2z"/></svg>
          <span>Layer</span>
        </button>
        <button class="panel-tab-btn" data-content="legend-content">
          <svg viewBox="0 0 24 24"><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
          <span>Legenda</span>
        </button>
      </div>
      <div id="panel-controls">
        <button id="panel-minimize-btn" class="min-btn" title="Minimize">+</button>
      </div>
    </div>
    <div id="panel-body" style="display: none;">
      <div id="basemap-content" class="panel-content active">
        <h4>Pilih Basemap</h4>
        <div id="basemap-tabs" class="tab-control-group">
          <button class="tab-btn" data-value="esri">ESRI World Topo</button>
          <button class="tab-btn active" data-value="osm">OpenStreetMap</button>
          <button class="tab-btn" data-value="imagery">Imagery</button>
        </div>
      </div>
      <div id="layer-content" class="panel-content">
        <h4>Pilih Layer Spasial</h4>
        <div id="layer-tabs" class="tab-control-group">
            <button class="tab-btn active" data-layer="troublespot">Troublespot</button>
            <button class="tab-btn active" data-layer="blackspot">Black Spot</button>
            <button class="tab-btn active" data-layer="traffic">Kemacetan</button>
            <button class="tab-btn active" data-layer="blacklink">Black Link</button>
            <button class="tab-btn active" data-layer="blackarea">Black Area</button>
            <button class="tab-btn active" data-layer="objek_vital">Objek Vital</button>
            <button class="tab-btn active" data-layer="cctv">CCTV</button>
            <button class="tab-btn" data-layer="prediksi_risiko">Prediksi Risiko Kecelakaan</button>
            <button class="tab-btn active" data-layer="administrasi">Wilayah Administrasi</button>
        </div>
      </div>
      <div id="legend-content" class="panel-content"></div>
    </div>
  </div>
</div>

<div id="controls-bl">
    <div id="measure-panel" class="minimized">
        <div id="measure-header">
            <span id="measure-title-minimized">Ukur</span>
            <h4 id="measure-title-expanded">Alat Ukur</h4>
            <button id="measure-toggle-btn" class="min-btn">+</button>
        </div>
        <div id="measure-body">
            <div id="measure-controls">
                <button id="btn-measure-dist" class="measure-btn">Jarak</button>
                <button id="btn-measure-area" class="measure-btn">Luas</button>
                <button id="btn-measure-clear" class="measure-btn" title="Hapus Ukuran">X</button>
            </div>
            <div id="measure-result">Pilih tool untuk mulai</div>
        </div>
    </div>
    <div id="zoom-compass">
        <div id="zoom-controls">
            <button id="zoom-in" class="zoom-btn" title="Zoom In">+</button>
            <button id="zoom-out" class="zoom-btn" title="Zoom Out">−</button>
        </div>
        <div id="compass" title="Reset North">
            <svg id="compass-arrow" viewBox="0 0 24 24" width="22" height="22" fill="#0d47a1"><path d="M12 2 L15 11 L12 9 L9 11 z"/><circle cx="12" cy="14" r="3" /></svg>
        </div>
        <div id="my-location-btn" title="Lokasi Saya">
          <svg xmlns="http://www.w3.org/2000/svg" height="22" viewBox="0 0 24 24" width="22" fill="#0d47a1"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
        </div>
    </div>
    <div id="scale-box"></div>
</div>

<script>
/* ================= KONFIGURASI & FUNGSI PETA UTAMA ================= */
// ... (Semua fungsi peta utama seperti initMap, loadAllDataLayers, updateDashboard, dll. ada di sini) ...
// (Kode ini sengaja tidak ditampilkan ulang karena tidak berubah, untuk menjaga keringkasan)

/* =================== FUNGSI-FUNGSI TOOLS =================== */
// (Kode ini sengaja tidak ditampilkan ulang karena tidak berubah, untuk menjaga keringkasan)

</script>
<script>
/* ================= KONFIGURASI & FUNGSI PETA UTAMA ================= */
const URLS = {
  wilayah: 'data/wilayah.geojson',
  troublespot: 'data/troublespot.geojson',
  blackspot: 'data/blackspot.geojson',
  traffic: 'data/traffic.geojson',
  blacklink: 'data/blacklink.geojson',
  blackarea: 'data/blackarea.geojson',
  cctv: 'data/cctv.geojson',
  objek_vital: 'data/objek_vital.geojson',
  prediksi_risiko: 'data/risk_prediction.geojson',
  administrasi: 'data/kependudukan.geojson',
  data_kecelakaan: 'data/data_kecelakaan.geojson'
};

const basemapTiles = {
  osm: { tiles:['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256 },
  esri:{ tiles:['https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'], tileSize:256 },
  imagery:{ tiles:['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize:256 }
};

const ICON_SVGS = {
  'road-closed': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='30' fill='#d32f2f'/><rect x='10' y='30' width='44' height='6' rx='3' fill='#fff'/></svg>`,
  'road-disturbance': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='#ffc107'/><path fill='#000' d='M11 7h2v6h-2zm0 8h2v2h-2z'/></svg>`,
  'kemacetan': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#d32f2f' d='M18.5,4H5.5C4.67,4,4,4.67,4,5.5v3C4,9.33,4.67,10,5.5,10h13c0.83,0,1.5-0.67,1.5-1.5v-3C20,4.67,19.33,4,18.5,4z M18.5,11h-13C4.67,11,4,11.67,4,12.5v3c0,0.83,0.67,1.5,1.5,1.5h13c0.83,0,1.5-0.67,1.5-1.5v-3C20,11.67,19.33,11,18.5,11z'/><rect x='5' y='6' width='2.8' height='2' fill='#fff'/><rect x='16.2' y='6' width='2.8' height='2' fill='#fff'/><rect x='5' y='13' width='2.8' height='2' fill='#fff'/><rect x='16.2' y='13' width='2.8' height='2' fill='#fff'/></svg>`,
  'kecelakaan': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#212121' d='M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11C5.84 5 5.28 5.42 5.08 6.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 12c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9s1.5.67 1.5 1.5S7.33 12 6.5 12zm11 0c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/><path fill='red' d='M5 4L3 8l2 1l2-4zm14 0l-2 4l2 1l2-4z'/></svg>`,
  'blackspot': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><polygon points='32,6 58,54 6,54' fill='#212121' stroke='#e53935' stroke-width='5' stroke-linejoin='round'/><path fill='#fff' d='M30,22 h4 v14 h-4 z M30,40 h4 v4 h-4 z'/></svg>`,
  'cctv-on': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='7' width='14' height='10' rx='2' fill='green'/><circle cx='10' cy='12' r='3.2' fill='#fff'/><circle cx='10' cy='12' r='2' fill='green'/><rect x='17' y='9' width='4' height='6' fill='green'/></svg>`,
  'cctv-off': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='7' width='14' height='10' rx='2' fill='red'/><circle cx='10' cy='12' r='3.2' fill='#fff'/><circle cx='10' cy='12' r='2' fill='red'/><rect x='17' y='9' width='4' height='6' fill='red'/><path d='M5 18 L18 6' stroke='#fff' stroke-width='2'/></svg>`,
  'ov-plane': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='navy' d='M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z'/></svg>`,
  'ov-hospital': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='4' y='4' width='16' height='16' rx='3' fill='red'/><rect x='11' y='7' width='2' height='10' fill='#fff'/><rect x='7' y='11' width='10' height='2' fill='#fff'/></svg>`,
  'ov-school': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><polygon points='12,4 20,9 4,9' fill='#8d6e63'/><rect x='4' y='9' width='16' height='9' fill='saddlebrown'/><rect x='11' y='12' width='2' height='6' fill='#fff'/></svg>`,
  'ov-government': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><polygon points='12,5 20,9 4,9' fill='dimgray'/><rect x='5' y='9' width='14' height='9' fill='dimgray'/><rect x='7' y='11' width='2' height='6' fill='#fff'/><rect x='11' y='11' width='2' height='6' fill='#fff'/><rect x='15' y='11' width='2' height='6' fill='#fff'/></svg>`,
  'ov-police': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 4c3 2 6 1 6 1v6c0 4-2 6-6 9-4-3-6-5-6-9V5s3 1 6-1z' fill='blue'/><polygon points='12,9 13,11 15,11 13.5,12.2 14,14 12,13 10,14 10.5,12.2 9,11 11,11' fill='#fff'/></svg>`,
  'ov-train': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='black' d='M12 2c-4 0-8 .5-8 4v10.5c0 1.5 1.5 2.5 3 2.5h2.5c.5 0 .5-1 0-1H7c-1 0-1.5-.5-1.5-1.5S6 16 7 16h10c1 0 1.5.5 1.5 1.5s-.5 1.5-1.5 1.5h-1.5c-.5 0-.5 1 0 1H17c1.5 0 3-1 3-2.5V6c0-3.5-4-4-8-4zm0 2c2.5 0 5 .5 5 2H7c0-1.5 2.5-2 5-2z'/><rect x='8' y='8' width='8' height='4' fill='#fff'/></svg>`,
  'ov-bus': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='darkorange' d='M18,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V4C20,2.9,19.1,2,18,2z M18,14H6v-4h12V14z'/><rect x='6' y='4' width='12' height='2' fill='#fff'/><circle fill='black' cx="8.5" cy="17" r="1.5"/><circle fill='black' cx="15.5" cy="17" r="1.5"/></svg>`,
  'ov-pariwisata': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#4dd0e1' d='M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z'/><path fill='#fff' d='M12,17c-2.76,0-5-2.24-5-5s2.24-5,5-5s5,2.24,5,5S14.76,17,12,17z'/><circle fill='#82e9f4' cx='12' cy='12' r='3'/></svg>`,
  'ov-port': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='#006064' d='M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11h20V8c0-1.11-.89-2-2-2zm-6-2h-4v2h4V4z'/><circle cx='6' cy='14' r='1.5' fill='#fff'/><circle cx='18' cy='14' r='1.5' fill='#fff'/></svg>`,
  'default': `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='#9e9e9e' stroke='#fff' stroke-width='1.5'/></svg>`
};

const ALIAS_MAP = {
  city:'Kabupaten / Kota', street:'Jalan', keterangan:'Keterangan',
  Nm_Ruas:'Nama Ruas Jalan', Status:'Status Jalan', Propinsi:'Provinsi',
  Kab_Kot:'Kabupaten / Kota', SkorBS:'Skor Black Spot', Ket:'Keterangan',
  Coverage:'Keterangan Blindspot', tanggal:'Tanggal', Wilayah:'Wilayah',
  level:'Level Kemacetan', speedKMH:'Kecepatan', Nama:'Nama',
  Keterangan:'Keterangan', nama_cctv:'Nama CCTV', status:'Status',
  sumber:'Sumber', nama_jalan:'Nama Jalan', risk_prediction:'Risiko Kecelakaan',
  nama_prop:'Nama Provinsi', nama_kab:'Nama Kabupaten / Kota', nama_kec:'Nama Kecamatan'
};

let map;
let wilayahData;
let selectedPolygon = null;
let administrasiColorMap = {};
let popup = new maplibregl.Popup({ closeButton:true, closeOnClick:true, offset:12 });
let troublespotChart, cctvChart;
let filteredLayerData = {};
// Variabel baru untuk manajemen time slider
let timeSliderData = {
    allFeatures: { blackspot: [], blacklink: [], blackarea: [] },
    uniqueDates: [],
    slider: null,
    labelStart: null,
    labelEnd: null,
    tooltip: null,
    panel: null
};

/**
 * Menginisialisasi Time Slider dengan data tanggal dari layer yang relevan.
 */
function initTimeSlider() {
    // 1. Ambil semua elemen DOM yang diperlukan
    const slider = document.getElementById('time-slider');
    const labelStart = document.getElementById('slider-label-start');
    const labelEnd = document.getElementById('slider-label-end');
    const tooltip = document.getElementById('slider-tooltip');
    const panel = document.getElementById('time-slider-panel');
    const wrapper = document.getElementById('time-slider-wrapper');
    const toggleBtn = document.getElementById('time-slider-toggle-btn');
    const minimizedBtn = document.getElementById('time-slider-minimized-btn');

    // Sembunyikan semua elemen slider di awal
    if (wrapper) wrapper.style.display = 'none';
    if (panel) panel.style.display = 'none';
    if (minimizedBtn) minimizedBtn.style.display = 'none';

    // 2. Kumpulkan fitur dan tanggal
    const features = [
        ...(timeSliderData.allFeatures.blackspot || []),
        ...(timeSliderData.allFeatures.blacklink || []),
        ...(timeSliderData.allFeatures.blackarea || [])
    ];
    
    // =================================================================
    // PERBAIKAN 1: Jika tidak ada fitur, update dasbor lalu keluar
    // =================================================================
    if (!features.length) {
        if (wrapper) wrapper.style.display = 'none';
        updateDashboard(null); // Panggil updateDashboard dengan null
        return;
    }
    
    const allDates = features.map(f => f.properties.tanggal).filter(Boolean).map(dateStr => new Date(dateStr));
    const uniqueDates = [...new Set(allDates.map(d => d.getTime()))].map(time => new Date(time)).sort((a, b) => a - b);
    timeSliderData.uniqueDates = uniqueDates; // Simpan tanggal unik

    // =================================================================
    // PERBAIKAN 2: Jika tanggal tidak cukup, update dasbor lalu keluar
    // =================================================================
    if (uniqueDates.length < 2) {
        if (wrapper) wrapper.style.display = 'none';
        updateDashboard(uniqueDates.length > 0 ? uniqueDates[0] : null); // Panggil updateDashboard dengan tanggal tunggal jika ada
        return;
    }
    
    // 3. Konfigurasi slider (logika tidak berubah)
    const dateOptions = { day: 'numeric', month: 'short', year: 'numeric' };
    const firstDate = uniqueDates[0];
    const lastDate = uniqueDates[uniqueDates.length - 1];
    slider.min = 0;
    slider.max = uniqueDates.length - 1;
    slider.value = uniqueDates.length - 1;
    labelStart.textContent = firstDate.toLocaleDateString('id-ID', dateOptions);
    labelEnd.textContent = lastDate.toLocaleDateString('id-ID', dateOptions);

    // 4. Tambahkan event listener (logika tidak berubah)
    slider.addEventListener('input', () => {
        const dateIndex = parseInt(slider.value, 10);
        const selectedDate = uniqueDates[dateIndex];
        filterLayersByDate(selectedDate);
        updateDashboard(selectedDate);
    });
    slider.addEventListener('mousemove', (e) => {
        const rect = slider.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        const dateIndex = Math.round(percent * (uniqueDates.length - 1));
        const hoverDate = uniqueDates[dateIndex];
        if (hoverDate) {
            tooltip.textContent = hoverDate.toLocaleDateString('id-ID', dateOptions);
            tooltip.style.left = `${percent * 100}%`;
            tooltip.style.opacity = 1;
        }
    });
    slider.addEventListener('mouseleave', () => {
        tooltip.style.opacity = 0;
    });

    // Logika untuk tombol minimize/maximize (tidak berubah)
    toggleBtn.addEventListener('click', () => {
        panel.style.display = 'none';
        minimizedBtn.style.display = 'block';
    });

    minimizedBtn.addEventListener('click', () => {
        panel.style.display = 'flex';
        minimizedBtn.style.display = 'none';
    });
    
    // 5. Tampilkan wrapper dalam keadaan minimized secara default (tidak berubah)
    if (wrapper) wrapper.style.display = 'block';
    if (panel) panel.style.display = 'none';
    if (minimizedBtn) minimizedBtn.style.display = 'block';
    
    // Filter peta DAN dashboard ke tanggal terbaru secara default (tidak berubah)
    filterLayersByDate(lastDate);
    updateDashboard(lastDate);
}

/**
 * Memfilter layer blackspot, blacklink, dan blackarea HANYA PADA tanggal yang dipilih.
 */
function filterLayersByDate(selectedDate) {
    // Mengatur waktu ke awal hari untuk perbandingan yang akurat
    const startTime = new Date(selectedDate);
    startTime.setHours(0, 0, 0, 0);

    // Mengatur waktu ke akhir hari untuk perbandingan
    const endTime = new Date(selectedDate);
    endTime.setHours(23, 59, 59, 999);
    
    ['blackspot', 'blacklink', 'blackarea'].forEach(layerKey => {
        const source = map.getSource(layerKey);
        if (!source || !timeSliderData.allFeatures[layerKey]) return;

        // =========================================================
        // PERUBAHAN UTAMA DI SINI
        // =========================================================
        // Filter fitur yang tanggalnya HANYA PADA hari yang dipilih
        const filteredFeatures = timeSliderData.allFeatures[layerKey].filter(f => {
            if (!f.properties.tanggal) return false;
            const featureDate = new Date(f.properties.tanggal);
            
            // Cek apakah tanggal fitur berada di antara awal dan akhir hari yang dipilih
            return featureDate >= startTime && featureDate <= endTime;
        });

        // Update data di peta
        source.setData({
            type: 'FeatureCollection',
            features: filteredFeatures
        });
    });
}
// === PETA AWAL (KANAN) & CALL OUT SATWIL ===
let splashMap; // peta di layar awal (kanan)
const START_SATWIL = ['Polda Bali', 'Polrestabes Bandung', 'Polresta Surakarta'];

let splashChartInstance = null; // Variabel untuk menyimpan instance grafik

/**
 * Mengubah objek Date menjadi string YYYY-MM-DD berdasarkan waktu lokal.
 * @param {Date} date - Objek tanggal yang akan diformat.
 * @returns {string} - String tanggal dengan format "YYYY-MM-DD".
 */
function toYYYYMMDD(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Bulan adalah 0-indexed
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

async function createSplashChart() {
    try {
        // 1. Ambil seluruh data kecelakaan
        const response = await fetch(URLS.data_kecelakaan);
        if (!response.ok) throw new Error('Gagal memuat data_kecelakaan.geojson.');
        const accidentData = await response.json();
        
        // 2. Siapkan rentang tanggal: hari ini dan 6 hari sebelumnya
        const today = new Date();
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(today.getDate() - 6);
        sevenDaysAgo.setHours(0, 0, 0, 0);
        today.setHours(23, 59, 59, 999);

        // 3. Buat wadah untuk menampung hitungan per hari
        const dailyCounts = new Map();
        for (let i = 0; i < 7; i++) {
            const date = new Date(sevenDaysAgo);
            date.setDate(date.getDate() + i);
            const dateString = toYYYYMMDD(date);
            dailyCounts.set(dateString, 0);
        }

        // 4. Filter dan hitung data kecelakaan dalam 7 hari terakhir
        accidentData.features.forEach(feature => {
            const dateString = feature.properties?.tanggal_kejadian;
            if (!dateString) return;

            // =================================================================
            // PERBAIKAN DI SINI: Kembali menggunakan new Date() langsung
            // karena format YYYY-MM-DD sudah standar.
            // =================================================================
            const eventDate = new Date(dateString);
            
            // Cek apakah tanggal valid dan berada dalam rentang 7 hari
            if (!isNaN(eventDate) && eventDate >= sevenDaysAgo && eventDate <= today) {
                const formattedDateString = toYYYYMMDD(eventDate);
                if (dailyCounts.has(formattedDateString)) {
                    dailyCounts.set(formattedDateString, dailyCounts.get(formattedDateString) + 1);
                }
            }
        });

        // 5. Siapkan data untuk Chart.js (tidak ada perubahan)
        const labels = Array.from(dailyCounts.keys()).map(dateStr => {
            const [year, month, day] = dateStr.split('-');
            const localDate = new Date(year, month - 1, day);
            return localDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        });
        const dataValues = Array.from(dailyCounts.values());
        
        // 6. Dapatkan elemen canvas dan render grafik (tidak ada perubahan)
        const ctx = document.getElementById('splash-troublespot-chart')?.getContext('2d');
        if (!ctx) return;
        if (splashChartInstance) {
            splashChartInstance.destroy();
        }

        splashChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jumlah Kecelakaan',
                    data: dataValues,
                    backgroundColor: 'rgba(255, 193, 7, 0.2)',
                    borderColor: '#ffc107',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#ffc107',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Tren Kejadian Kecelakan dalam 7 Hari Terakhir',
                        color: '#fff',
                        font: { size: 14 }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            color: 'rgba(255, 255, 255, 0.7)',
                            precision: 0,
                            stepSize: 1
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        // =========================================================
        // PENAMBAHAN DI SINI: Tampilkan Waktu "Last Update"
        // =========================================================
        const now = new Date();
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        const day = now.getDate();
        const month = monthNames[now.getMonth()];
        const year = now.getFullYear();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        const timestampText = `Last Update: ${day} ${month} ${year} Pukul ${hours}:${minutes}`;

        const updateElement = document.getElementById('splash-last-update');
        if (updateElement) {
            updateElement.textContent = timestampText;
        }
    } catch (error) {
        console.error("Gagal membuat splash chart:", error);
        const container = document.getElementById('splash-chart-container');
        if(container) container.innerHTML = '<p style="color: #ff8a80;">Gagal memuat data grafik.</p>';
    }
}

function startAppWithSatwil(feature) {
  // Simpan pilihan & mulai aplikasi utama
  selectedPolygon = feature;
  const sat = feature?.properties?.Satwil ?? feature?.properties?.satwil;

  // Tutup peta awal dan layar overlay hitam (#filter-screen)
  try { if (splashMap) { splashMap.remove(); splashMap = null; } } catch {}
  showOverlay();
  document.getElementById('filter-screen').style.display = 'none';

  // Set nilai dropdown Satwil (panel atas) agar konsisten
  const panelSel = document.getElementById('wilayah-select');
  if (panelSel && sat) panelSel.value = sat;

  // Jalankan peta utama
  if (!map) {
    initMap(feature);
  } else {
    updateForSatwil(feature).finally(hideOverlay);
  }
}

function createSplashCallout(label, coord, feature) {
  // Stack ringan: pecah sebelum kata terakhir → dua baris rapi
  const stacked = /\s/.test(label) ? label.replace(/\s+([^\s]+)$/, '<br>$1') : label;

  const html = `<div class="splash-callout-content" tabindex="0" role="button">${stacked}</div>`;

  const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
      anchor: 'bottom',
      offset: 10
    })
    .setLngLat(coord)
    .setHTML(html)
    .addTo(splashMap);

  // klik/keyboard → jalankan app dgn satwil tsb
  const content = popup.getElement().querySelector('.maplibregl-popup-content');
  content.addEventListener('click', () => startAppWithSatwil(feature));
  content.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' || ev.key === ' ') startAppWithSatwil(feature);
  });
}

function initSplashMap() {
  // Buat peta MapLibre di panel kanan layar awal
  splashMap = new maplibregl.Map({
    container: 'splash-map',
    style: {
      version: 8,
      sources: {
        'base-raster': {
          type: 'raster',
          tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'],
          tileSize: 256
        }
      },
      layers: [{ id:'base-raster-layer', type:'raster', source:'base-raster' }]
    },
    center: [118.0149, -2.5489],
    zoom: 4.2,                      // agak menjauh; nanti fitBounds yang ngatur
    attributionControl: false,
    renderWorldCopies: false        // << penting: hindari “duplikasi dunia”
  });
  splashMap.setMaxBounds([[94.5, -12.5], [142.0, 8.0]]);
  splashMap.on('load', () => {
    const targets = [];
    const targetNames = new Set(START_SATWIL.map(s => s.toLowerCase()));

    for (const f of (wilayahData?.features || [])) {
      const sat = (f.properties?.Satwil ?? f.properties?.satwil ?? '').toString();
      if (!sat) continue;
      if (targetNames.has(sat.toLowerCase())) {
        let cen;
        try {
          cen = turf.centerOfMass(f).geometry.coordinates;
        } catch(e) {
          try { cen = turf.centroid(f).geometry.coordinates; }
          catch { cen = null; }
        }
        // Jika jatuh di luar polygon (kasus multipoligon), pakai pusat bbox
        try {
          if (!cen || !turf.booleanPointInPolygon(turf.point(cen), f)) {
            const bb = turf.bbox(f);
            cen = [(bb[0]+bb[2])/2, (bb[1]+bb[3])/2];
          }
        } catch {}
        createSplashCallout(sat, cen, f);
        targets.push(cen);
      }
    }

    // Fit agar ketiga callout terlihat
    if (targets.length) {
      const fc = {
        type:'FeatureCollection',
        features: targets.map(c => ({ type:'Feature', geometry:{ type:'Point', coordinates:c } }))
      };
      splashMap.fitBounds( turf.bbox(fc), { padding: { top: 80, right: 80, bottom: 140, left: 80 }, maxZoom: 5.8 });
    }
  });
}

const overlay = document.getElementById('loading-overlay');
function showOverlay() { if(overlay) overlay.style.display = 'flex'; }
function hideOverlay() { if(overlay) overlay.style.display = 'none'; }

// === LOGIKA UNTUK TOMBOL PETUNJUK DI SPLASH SCREEN ===
document.addEventListener('DOMContentLoaded', () => {
    const hintButton = document.getElementById('btn-show-hint');
    const hintText = document.getElementById('hint-text-overlay');

    if (hintButton && hintText) {
        hintButton.addEventListener('click', () => {
            // 1. Tampilkan teks petunjuk
            hintText.classList.add('visible');

            // 2. Temukan semua elemen popup di peta splash
            const splashMapContainer = document.getElementById('splash-map');
            if (splashMapContainer) {
                const popups = splashMapContainer.querySelectorAll('.maplibregl-popup');
                
                // 3. Tambahkan kelas highlight ke semua popup
                popups.forEach(popup => {
                    popup.classList.add('highlight-pin');
                });

                // 4. Setelah 3 detik, sembunyikan teks dan hapus highlight
                setTimeout(() => {
                    hintText.classList.remove('visible');
                    popups.forEach(popup => {
                        popup.classList.remove('highlight-pin');
                    });
                }, 3000); // Durasi 3 detik (2 putaran animasi)
            }
        });
    }
});

fetch(URLS.wilayah).then(r=>r.json()).then(data=>{
  wilayahData = data;
  const panelSel = document.getElementById('wilayah-select');
  const seen = new Set();
  for (const f of data.features || []) {
    const sat = f.properties?.Satwil ?? f.properties?.satwil;
    if (!sat || seen.has(sat)) continue;
    seen.add(sat);
    const o = document.createElement('option');
    o.value = sat; o.textContent = sat;
    panelSel.appendChild(o);
  }
  // === Inisialisasi peta awal (kanan) setelah wilayah siap ===
  initSplashMap();
  createSplashChart();

}).catch(err=>{
  console.error('Gagal load wilayah.geojson', err);
  alert('Gagal memuat wilayah.geojson');
});

document.getElementById('btn-ganti').addEventListener('click', async ()=>{
  const v = document.getElementById('wilayah-select').value;
  if (!v) return alert('Pilih Satwil');
  const feat = (wilayahData?.features || []).find(f => (f.properties?.Satwil ?? f.properties?.satwil) === v);
  if (!feat) return alert('Satwil tidak ditemukan');
  showOverlay();
  selectedPolygon = feat;
  await updateForSatwil(selectedPolygon);
  hideOverlay();
});

function initMap(polygon){
  map = new maplibregl.Map({
    container:'map',
    style:{
      version:8,
      glyphs:"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
      sources:{ 'base-raster':{ type:'raster', tiles:basemapTiles.osm.tiles, tileSize:basemapTiles.osm.tileSize } },
      layers:[ { id:'base-raster-layer', type:'raster', source:'base-raster' } ]
    },
    center:[118.0149, -2.5489], zoom:5, attributionControl:false
  });

  map.on('load', async ()=>{
    ['main-header','filter-panel','bottom-panel-wrapper','controls-bl','dashboard-panel','search-routing-panel'].forEach(id=>document.getElementById(id).style.display='flex');
    map.addControl(new maplibregl.AttributionControl({ compact:true }), 'bottom-right');
    const scl = new maplibregl.ScaleControl({ maxWidth:120, unit:'metric' });
    document.getElementById('scale-box').appendChild(scl.onAdd(map));
    document.getElementById('zoom-in').addEventListener('click', ()=>map.zoomIn());
    document.getElementById('zoom-out').addEventListener('click', ()=>map.zoomOut());
    document.getElementById('compass').addEventListener('click', ()=>map.easeTo({ bearing:0, pitch:0 }));
    const updateCompass = () => document.getElementById('compass-arrow').style.transform = `rotate(${-map.getBearing()}deg)`;
    map.on('rotate', updateCompass); updateCompass();

    // === LOGIKA UNTUK MINIMIZE ITEM DI DASHBOARD ===
    document.querySelectorAll('.dash-item-header').forEach(header => {
      header.addEventListener('click', () => {
        const container = header.closest('.dash-item-container');
        const button = header.querySelector('.dash-item-toggle');
        
        container.classList.toggle('minimized');
        
        const isMinimized = container.classList.contains('minimized');
        button.textContent = isMinimized ? '+' : '−';
      });
    });

    // === LOGIKA UNTUK TOMBOL LOKASI SAYA ===
    const myLocationBtn = document.getElementById('my-location-btn');
    let myLocationMarker = null; // Untuk menyimpan marker

    myLocationBtn.addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert("Geolocation tidak didukung oleh browser Anda.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { longitude, latitude } = position.coords;
          
          // Hapus marker lama jika ada
          if (myLocationMarker) {
            myLocationMarker.remove();
          }

          // Pindahkan peta ke lokasi pengguna
          map.flyTo({
            center: [longitude, latitude],
            zoom: 16, // Zoom lebih dekat
            speed: 1.5
          });

          // Tambahkan marker baru di lokasi pengguna
          myLocationMarker = new maplibregl.Marker({ color: '#1976d2' }) // Warna biru
            .setLngLat([longitude, latitude])
            .addTo(map);
        },
        (error) => {
          // Tangani error
          switch (error.code) {
            case error.PERMISSION_DENIED:
              alert("Anda menolak permintaan untuk Geolocation.");
              break;
            case error.POSITION_UNAVAILABLE:
              alert("Informasi lokasi tidak tersedia.");
              break;
            case error.TIMEOUT:
              alert("Permintaan untuk mendapatkan lokasi pengguna timed out.");
              break;
            default:
              alert("Terjadi kesalahan yang tidak diketahui.");
              break;
          }
        }
      );
    });

    initSearchAndRouting();
    initMeasureTools(map);
    
    await loadIcons();
    addOrUpdateSatwilLayer(polygon);
    await loadAllDataLayers(polygon);
    // =========================================================
    // PENAMBAHAN DI SINI: Panggil inisialisasi slider
    // =========================================================
    initTimeSlider();
    renderLegend();
    updateDashboard();
    window.updateSearchIndex();
    
    hideOverlay();

    try{ map.fitBounds(turf.bbox(polygon), { padding:50, maxZoom:14 }); }catch(e){}

    // === LOGIKA BARU UNTUK TOMBOL BASEMAP & LAYER ===

    // 1. Logika untuk Basemap (Single Choice)
    const basemapBtns = document.querySelectorAll('#basemap-tabs .tab-btn');
    basemapBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Hapus 'active' dari semua tombol basemap
        basemapBtns.forEach(b => b.classList.remove('active'));
        // Tambahkan 'active' ke tombol yang diklik
        btn.classList.add('active');
        // Ganti basemap
        switchBasemap(btn.dataset.value);
      });
    });

    // 2. Logika untuk Layer Spasial (Multiple Choice)
    const layerBtns = document.querySelectorAll('#layer-tabs .tab-btn');
    layerBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Toggle kelas 'active'
        btn.classList.toggle('active');
        const isActive = btn.classList.contains('active');
        const layerName = btn.dataset.layer;

        // Tampilkan atau sembunyikan layer di peta
        (map.getStyle().layers || []).forEach(l => {
          if (l.id.startsWith(layerName)) {
            map.setLayoutProperty(l.id, 'visibility', isActive ? 'visible' : 'none');
          }
        });
        
        // Perbarui legenda
        renderLegend();
      });
    });

    map.on('click', (e)=>{
      if (popup && popup.isOpen()) popup.remove();
      const features = map.queryRenderedFeatures(e.point);
      if (!features.length) return;

      const topFeature = features[0];
      const layerId = topFeature.layer.id;
      if (topFeature.properties?.cluster){
        const clusterId = topFeature.properties.cluster_id;
        const sourceId = topFeature.layer.source;
        const source = map.getSource(sourceId);
        if (source && typeof source.getClusterExpansionZoom === 'function'){
          source.getClusterExpansionZoom(clusterId, (err, zoom)=>{
            if (err) return;
            map.easeTo({ center: topFeature.geometry.coordinates, zoom: zoom + 1 });
          });
        }
        return;
      }
      const titleMap = {
        troublespot:'Troublespot', blackspot:'Black Spot', cctv:'CCTV',
        objek_vital:'Objek Vital', prediksi_risiko:'Prediksi Risiko Kecelakaan',
        administrasi:'Wilayah Administrasi', traffic:'Kemacetan',
        blacklink:'Black Link', blackarea:'Black Area'
      };
      const prefix = Object.keys(titleMap).find(p => layerId.startsWith(p));
      if (!prefix) return;
      let title = titleMap[prefix] || 'Informasi';
      if (prefix === 'objek_vital'){
        const ovLabel = OV_META[ovKeyFromKeterangan(topFeature.properties)]?.label || 'Lainnya';
        title = `Objek Vital • ${ovLabel}`;
      }
      let bodyHtml = '';
      for (const key in ALIAS_MAP){
        if (topFeature.properties.hasOwnProperty(key)){
          bodyHtml += `<div><strong>${ALIAS_MAP[key]}:</strong> ${topFeature.properties[key]}</div>`;
        }
      }
      if (bodyHtml === '') bodyHtml = '<div>Tidak ada informasi detail.</div>';
      const popupHtml = `<div class="popup-header">${title}</div><div class="popup-body">${bodyHtml}</div>`;
      popup.setLngLat(e.lngLat).setHTML(popupHtml).addTo(map);
    });

    const panelMinimizeBtn = document.getElementById('panel-minimize-btn');
    const panelBody = document.getElementById('panel-body');
    const bottomPanel = document.getElementById('bottom-panel');
    const toggleMinimize = (panel, body, btn) => {
      const isMinimized = panel.classList.toggle('minimized');
      body.style.display = isMinimized ? 'none' : 'block';
      btn.textContent = isMinimized ? '+' : '−';
    };
    panelMinimizeBtn.addEventListener('click', ()=>toggleMinimize(bottomPanel, panelBody, panelMinimizeBtn));
    document.getElementById('panel-header').addEventListener('click', (e) => {
        if (bottomPanel.classList.contains('minimized') && e.target.closest('#panel-tabs')) {
             toggleMinimize(bottomPanel, panelBody, panelMinimizeBtn);
        }
    });

    document.querySelectorAll('.panel-tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (bottomPanel.classList.contains('minimized')) {
            toggleMinimize(bottomPanel, panelBody, panelMinimizeBtn);
        }
        document.querySelectorAll('.panel-tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.panel-content').forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.content).classList.add('active');
      });
    });

    const dashboardBody = document.getElementById('dashboard-body');
    const dashboardMinimizeBtn = document.getElementById('dashboard-minimize-btn');
    dashboardMinimizeBtn.addEventListener('click', ()=>{
      const hidden = dashboardBody.style.display === 'none';
      dashboardBody.style.display = hidden ? 'block' : 'none';
      dashboardMinimizeBtn.textContent = hidden ? '−' : '+';
    });
  });
}
async function loadIcons(){
  for (const [id, svg] of Object.entries(ICON_SVGS)){
    await new Promise((resolve, reject)=>{
      if (map.hasImage(id)) return resolve();
      const img = new Image();
      img.onload = ()=>{ try{ map.addImage(id, img); resolve(); }catch(e){ reject(e); } };
      img.onerror = reject;
      img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }).catch(e=>console.warn('addImage failed for', id, e));
  }
}
function switchBasemap(key){
  if (!map || !basemapTiles[key]) return;
  const layers = map.getStyle().layers || [];
  const firstNonBaseId = layers.find(l => l.id !== 'base-raster-layer')?.id;
  if (map.getLayer('base-raster-layer')) map.removeLayer('base-raster-layer');
  if (map.getSource('base-raster')) map.removeSource('base-raster');
  map.addSource('base-raster', { type:'raster', tiles: basemapTiles[key].tiles, tileSize: basemapTiles[key].tileSize });
  if (firstNonBaseId) map.addLayer({ id:'base-raster-layer', type:'raster', source:'base-raster' }, firstNonBaseId);
  else map.addLayer({ id:'base-raster-layer', type:'raster', source:'base-raster' });
}
function addOrUpdateSatwilLayer(feature){
  const source = map.getSource('selected-satwil');
  if (source) source.setData(feature);
  else map.addSource('selected-satwil', { type:'geojson', data:feature });
}
function toPointFeatureArray(fc){
  const out = [];
  if (!fc || !fc.features) return out;
  for (const f of fc.features){
    if (!f || !f.geometry) continue;
    const g = f.geometry;
    if (g.type === 'Point') out.push(f);
    else if (g.type === 'MultiPoint'){
      for (const c of g.coordinates || []) out.push({ type:'Feature', geometry:{ type:'Point', coordinates:c }, properties:{ ...f.properties } });
    } else {
      try {
        const cen = turf.centroid(f).geometry.coordinates;
        out.push({ type:'Feature', geometry:{ type:'Point', coordinates:cen }, properties:{ ...f.properties, _from:g.type } });
      } catch(e){}
    }
  }
  return out;
}
// Pecah Feature<MultiLineString> menjadi array Feature<LineString>
function toLineStringFeatures(feature) {
  if (!feature || !feature.geometry) return [];
  const { type, coordinates } = feature.geometry;
  if (type === 'LineString') return [feature];
  if (type === 'MultiLineString') {
    return (coordinates || []).map(coords => ({
      type: 'Feature',
      geometry: { type: 'LineString', coordinates: coords },
      properties: { ...(feature.properties || {}) }
    }));
  }
  return [];
}

// Ubah batas poligon Satwil menjadi array LineString boundary yang sederhana
function polygonBoundaryLineStrings(polygon) {
  const boundary = turf.polygonToLine(polygon); // bisa LineString atau MultiLineString
  const g = boundary && boundary.geometry;
  if (!g) return [];
  if (g.type === 'LineString') return [boundary];
  if (g.type === 'MultiLineString') {
    return (g.coordinates || []).map(coords => ({
      type: 'Feature',
      geometry: { type: 'LineString', coordinates: coords },
      properties: {}
    }));
  }
  return [];
}

// Split satu LineString oleh banyak garis boundary secara bertahap
function splitLineByBoundaries(lineLS, boundaryLines) {
  let pieces = [lineLS];
  for (const b of boundaryLines) {
    const next = [];
    for (const p of pieces) {
      try {
        const result = turf.lineSplit(p, b);
        if (result && result.features && result.features.length) {
          for (const s of result.features) {
            // warisi properti dari line asli
            s.properties = { ...(p.properties || {}) };
            next.push(s);
          }
        } else {
          next.push(p); // tidak terbelah, lanjutkan
        }
      } catch (e) {
        // Jika lineSplit error untuk kombinasi tertentu, pertahankan potongan saat ini
        next.push(p);
      }
    }
    pieces = next;
  }
  return pieces;
}

// Ambil potongan yang benar-benar di dalam polygon (cek midpoint tiap segmen)
function keepSegmentsInsidePolygon(pieces, polygon) {
  const kept = [];
  for (const seg of pieces) {
    try {
      const coords = seg?.geometry?.coordinates || [];
      if (coords.length < 2) continue;
      const lenKm = turf.length(seg, { units: 'kilometers' });
      // gunakan 50% panjang sebagai midpoint; jika nol, along(0) = titik awal
      const mid = turf.along(seg, Math.max(lenKm / 2, 0), { units: 'kilometers' });
      if (turf.booleanPointInPolygon(mid, polygon)) {
        seg.properties = { ...(seg.properties || {}) };
        kept.push(seg);
      }
    } catch (e) {}
  }
  return kept;
}

// Fallback aproksimasi: pecah line jadi chunk kecil, ambil chunk yang midpoint-nya berada di dalam poligon
function chunkApproxInside(lineLS, polygon, chunkKm = 0.5) {
  const out = [];
  try {
    const chunks = turf.lineChunk(lineLS, chunkKm, { units: 'kilometers' });
    for (const ch of (chunks.features || [])) {
      try {
        const lenKm = turf.length(ch, { units: 'kilometers' });
        const mid = turf.along(ch, Math.max(lenKm / 2, 0), { units: 'kilometers' });
        if (turf.booleanPointInPolygon(mid, polygon)) {
          ch.properties = { ...(lineLS.properties || {}) };
          out.push(ch);
        }
      } catch (e) {}
    }
  } catch (e) {}
  return out;
}

// === Fungsi CLIP utama yang lebih kebal terhadap MultiLineString & edge case ===
function clipLineToPolygonRobust(lineFeature, polygon) {
  try {
    if (!turf.booleanIntersects(lineFeature, polygon)) return [];
  } catch {
    return [];
  }

  const boundaryLines = polygonBoundaryLineStrings(polygon);
  const lines = toLineStringFeatures(lineFeature); // selalu LineString

  const out = [];
  for (const ls of lines) {
    try {
      // 1) coba split akurat dengan boundary
      const pieces = splitLineByBoundaries(ls, boundaryLines);
      let kept = keepSegmentsInsidePolygon(pieces, polygon);

      // 2) jika tetap tidak ada, cek full within
      if (!kept.length) {
        try {
          if (turf.booleanWithin(ls, polygon)) {
            const clone = JSON.parse(JSON.stringify(ls));
            clone.properties = { ...(lineFeature.properties || {}) };
            kept = [clone];
          }
        } catch {}
      }

      // 3) fallback aproksimasi (chunk) bila perlu
      if (!kept.length) {
        kept = chunkApproxInside(ls, polygon, 0.5); // ubah ke 0.25 jika perlu lebih rapat
      }

      for (const k of kept) {
        // wariskan properti dari feature asal (penting untuk styling risk_prediction)
        k.properties = { ...(lineFeature.properties || {}) };
        out.push(k);
      }
    } catch (e) {
      // fallback terakhir: aproksimasi
      const approx = chunkApproxInside(ls, polygon, 0.5);
      for (const k of approx) {
        k.properties = { ...(lineFeature.properties || {}) };
        out.push(k);
      }
    }
  }
  return out;
}
function filterData(layerKey, geojsonData, filterPolygon) {
  if (!geojsonData || !Array.isArray(geojsonData.features) || !filterPolygon) {
    return { type: 'FeatureCollection', features: [] };
  }

  const pointLayers = ['cctv', 'objek_vital', 'troublespot', 'blackspot'];

  if (pointLayers.includes(layerKey)) {
    // Titik: tetap pakai pointInPolygon
    const points = toPointFeatureArray(geojsonData);
    const filteredPoints = points.filter(pt => {
      try { return turf.booleanPointInPolygon(pt, filterPolygon); }
      catch (e) { console.error(`Error filtering point for ${layerKey}:`, e); return false; }
    });
    return { type: 'FeatureCollection', features: filteredPoints };
  } else {
    // === Perlakuan khusus untuk PREDIKSI_RISIKO (clip ke Satwil) ===
    if (layerKey === 'prediksi_risiko') {
      const out = [];
      for (const f of geojsonData.features) {
        if (!f?.geometry) continue;
        const gType = f.geometry.type;

        if (gType === 'LineString' || gType === 'MultiLineString') {
          const parts = clipLineToPolygonRobust(f, filterPolygon);
          if (parts.length) out.push(...parts);
        } else if (gType === 'Polygon' || gType === 'MultiPolygon') {
          // Jika ternyata ada poligon di data prediksi
          try {
            const inter = turf.intersect(f, filterPolygon);
            if (inter) { inter.properties = { ...f.properties }; out.push(inter); }
          } catch (e) { console.error('intersect error (prediksi_risiko polygon):', e); }
        } else {
          // Tipe lain (fallback): tetap saring intersects
          try { if (turf.booleanIntersects(f, filterPolygon)) out.push(f); } catch {}
        }
      }

      // (opsional) debug di console
      // console.log('[prediksi_risiko] hasil clip =', out.length);

      return { type: 'FeatureCollection', features: out };
    }

    // === Default untuk layer garis/poligon lainnya: cukup saring intersects ===
    return {
      type: 'FeatureCollection',
      features: geojsonData.features.filter(f => {
        if (!f?.geometry) return false;
        try { return turf.booleanIntersects(f, filterPolygon); }
        catch (e) { console.error(`Error filtering feature for ${layerKey}:`, e); return false; }
      })
    };
  }
}
function normalizeCCTVStatus(props){
  const v = (props?.status ?? '').toString().trim().toLowerCase();
  if (v === 'hidup') return 'on';
  if (v === 'mati') return 'off';
  return 'unknown';
}
function ovKeyFromKeterangan(props){
  const v = (props?.Keterangan ?? props?.keterangan ?? '').toString().trim().toLowerCase();
  if (v === 'bandara') return 'bandara';
  if (v === 'fasilitas kesehatan') return 'faskes';
  if (v === 'fasilitas pendidikan') return 'pendidikan';
  if (v === 'kantor pemerintahan') return 'pemerintahan';
  if (v === 'kantor polisi') return 'polisi';
  if (v === 'stasiun') return 'stasiun';
  if (v === 'terminal') return 'terminal';
  if (v === 'pariwisata') return 'pariwisata';
  if (v === 'pelabuhan') return 'pelabuhan';
  return 'default';
}
const OV_META = {
  bandara:{ icon:'ov-plane', color:'navy', label:'Bandara' },
  faskes:{ icon:'ov-hospital', color:'red', label:'Fasilitas Kesehatan' },
  pendidikan:{ icon:'ov-school', color:'saddlebrown', label:'Fasilitas Pendidikan' },
  pemerintahan:{ icon:'ov-government', color:'dimgray', label:'Kantor Pemerintahan' },
  polisi:{ icon:'ov-police', color:'blue', label:'Kantor Polisi' },
  stasiun:{ icon:'ov-train', color:'black', label:'Stasiun' },
  terminal:{ icon:'ov-bus', color:'darkorange', label:'Terminal' },
  pariwisata:{ icon:'ov-pariwisata', color:'#4e342e', label:'Pariwisata' },
  pelabuhan:{ icon:'ov-port', color:'#006064', label:'Pelabuhan' }, // BARU
  default:{ icon:'default', color:'#9e9e9e', label:'Lainnya' }
};
function setLayerInteractivity(layerId){
  map.on('mouseenter', layerId, ()=>{ map.getCanvas().style.cursor='pointer'; });
  map.on('mouseleave', layerId, ()=>{ map.getCanvas().style.cursor=''; });
}
async function loadAllDataLayers(polygon){
  const prefixes = ['troublespot','blackspot','traffic','blacklink','blackarea','cctv','objek_vital','prediksi_risiko','administrasi'];
  for (const p of prefixes){
    (map.getStyle().layers || []).map(l=>l.id).filter(id=>id.startsWith(p)).forEach(id=>{ if (map.getLayer(id)) map.removeLayer(id); });
    Object.keys(map.getStyle().sources || {}).filter(sid=>sid.startsWith(p)).forEach(sid=>{ if (map.getSource(sid)) map.removeSource(sid); });
  }
  filteredLayerData = {};
  const layerOrder = ['administrasi','blackarea','traffic','prediksi_risiko','blacklink','cctv','objek_vital','blackspot','troublespot'];

  for (const key of layerOrder){
    try{
      if (!URLS[key]) continue;
      const res = await fetch(URLS[key]);
      if (!res.ok) throw new Error(`Failed to fetch ${key}`);
      const json = await res.json();
      const filtered = filterData(key, json, polygon);
      filteredLayerData[key] = filtered;

      // KHUSUS UNTUK LAYER SLIDER: simpan data asli (sebelum difilter tanggal)
      if (['blackspot', 'blacklink', 'blackarea'].includes(key)) {
          timeSliderData.allFeatures[key] = filtered.features;
      }

      const applyVisibility = (layerPrefix)=>{
        // Diubah untuk mencari .tab-btn dan class .active
        const isVisible = document.querySelector(`.tab-btn[data-layer="${layerPrefix}"]`)?.classList.contains('active');
        if (isVisible === false){
          (map.getStyle().layers || []).forEach(l=>{ if (l.id.startsWith(layerPrefix)) map.setLayoutProperty(l.id, 'visibility', 'none'); });
        }
      };

      switch (key){
        case 'troublespot': {
          map.addSource('troublespot', { type:'geojson', data:filtered });
          map.addLayer({
            id:'troublespot-symbol', type:'symbol', source:'troublespot',
            layout:{ 'icon-image':['match',['get','keterangan'],'Jalan Ditutup','road-closed','Gangguan Jalan','road-disturbance','Titik Kemacetan','kemacetan','Kecelakaan','kecelakaan','road-disturbance'], 'icon-size':0.15, 'icon-allow-overlap':true }
          });
          setLayerInteractivity('troublespot-symbol'); applyVisibility(key); break;
        }
        case 'blackspot': {
          map.addSource('blackspot',{ type:'geojson', data:filtered });
          map.addLayer({
            id:'blackspot-symbol', type:'symbol', source:'blackspot',
            layout:{ 'icon-image':'blackspot','icon-size':0.15,'icon-allow-overlap':true }
          });
          setLayerInteractivity('blackspot-symbol'); applyVisibility(key); break;
        }
        case 'traffic': {
          map.addSource('traffic',{ type:'geojson', data:filtered });
          map.addLayer({
            id:'traffic-line', type:'line', source:'traffic',
            layout:{ 'line-join':'round', 'line-cap':'round' },
            paint:{ 'line-width':2, 'line-opacity':0.75, 'line-color':['interpolate',['linear'],['get','level'],1,'#ffeb3b',3,'#f44336',5,'#5d4037'] }
          });
          setLayerInteractivity('traffic-line'); applyVisibility(key); break;
        }
        case 'blacklink': {
          map.addSource('blacklink',{ type:'geojson', data:filtered });
          map.addLayer({ id:'blacklink-outline', type:'line', source:'blacklink', paint:{ 'line-width':4,'line-color':['match',['get','coverage'],'Black Link Blindspot','#e53935','Black Link Tercover CCTV','#212121','#777'] }});
          map.addLayer({ id:'blacklink-line', type:'line', source:'blacklink', paint:{ 'line-width':2,'line-color':['match',['get','coverage'],'Black Link Blindspot','#000','Black Link Tercover CCTV','#e53935','#444'] }});
          setLayerInteractivity('blacklink-line'); applyVisibility(key); break;
        }
        case 'blackarea': {
          map.addSource('blackarea',{ type:'geojson', data:filtered });
          map.addLayer({ id:'blackarea-fill', type:'fill', source:'blackarea', paint:{ 'fill-color':'#C0C0C0','fill-opacity':0.5 }});
          map.addLayer({ id:'blackarea-outline', type:'line', source:'blackarea', paint:{ 'line-color':'#000','line-width':1.5 }});
          setLayerInteractivity('blackarea-fill'); applyVisibility(key); break;
        }
        case 'cctv': {
          const onFC  = { type:'FeatureCollection', features: filtered.features.filter(f => normalizeCCTVStatus(f.properties)==='on') };
          const offFC = { type:'FeatureCollection', features: filtered.features.filter(f => normalizeCCTVStatus(f.properties)==='off') };
          const defs  = [ { key:'cctv-on', icon:'cctv-on', fc:onFC }, { key:'cctv-off', icon:'cctv-off', fc:offFC } ];
          for (const d of defs){
            if (!d.fc.features.length) continue;
            map.addSource(d.key,{ type:'geojson', data:d.fc, cluster:true, clusterRadius:50, clusterMaxZoom:15 });
            map.addLayer({
              id:`${d.key}-cluster`, type:'symbol', source:d.key, filter:['has','point_count'],
              layout:{ 'icon-image':d.icon,'icon-size':['interpolate',['linear'],['get','point_count'],2,0.2,50,0.3], 'icon-allow-overlap':true, 'text-field':['get','point_count'], 'text-font':['Noto Sans Bold'], 'text-size':12, 'text-allow-overlap':true },
              paint:{ 'text-color':'#fff','text-halo-color':'#000','text-halo-width':1.2 }
            });
            map.addLayer({
              id:`${d.key}-unclustered`, type:'symbol', source:d.key, filter:['!', ['has','point_count']],
              layout:{ 'icon-image':d.icon,'icon-size':0.15,'icon-allow-overlap':true }
            });
            setLayerInteractivity(`${d.key}-cluster`);
            setLayerInteractivity(`${d.key}-unclustered`);
          }
          applyVisibility(key); break;
        }
        case 'objek_vital': {
          const buckets = { bandara:[], faskes:[], pendidikan:[], pemerintahan:[], polisi:[], stasiun:[], terminal:[], pariwisata:[], pelabuhan:[], default:[] };
          for (const f of filtered.features) (buckets[ovKeyFromKeterangan(f.properties)] ?? buckets.default).push(f);
          const defs = Object.entries(buckets).map(([k,arr])=>({ key:`objek_vital-${k}`, fc:{ type:'FeatureCollection', features:arr }, ...OV_META[k] }));
          for (const d of defs){
            if (!d.fc.features.length) continue;
            map.addSource(d.key,{ type:'geojson', data:d.fc, cluster:true, clusterRadius:50, clusterMaxZoom:15 });
            map.addLayer({
              id:`${d.key}-cluster`, type:'symbol', source:d.key, filter:['has','point_count'],
              layout:{ 'icon-image':d.icon,'icon-size':['interpolate',['linear'],['get','point_count'],2,0.2,50,0.3], 'icon-allow-overlap':true, 'text-field':['get','point_count'], 'text-font':['Noto Sans Bold'], 'text-size':12, 'text-allow-overlap':true },
              paint:{ 'text-color':'#fff','text-halo-color':'#000','text-halo-width':1.2 }
            });
            map.addLayer({
              id:`${d.key}-unclustered`, type:'symbol', source:d.key, filter:['!', ['has','point_count']],
              layout:{ 'icon-image':d.icon,'icon-size':0.15,'icon-allow-overlap':true }
            });
            setLayerInteractivity(`${d.key}-cluster`);
            setLayerInteractivity(`${d.key}-unclustered`);
          }
          applyVisibility(key); break;
        }
        case 'prediksi_risiko': {
          map.addSource('prediksi_risiko', { type:'geojson', data:filtered });
          map.addLayer({ id:'prediksi_risiko-outline', type:'line', source:'prediksi_risiko', layout:{ 'line-join':'round', 'line-cap':'round' }, paint:{ 'line-width':2, 'line-color':'#000', 'line-opacity':0.5 }});
          map.addLayer({ id:'prediksi_risiko-line', type:'line', source:'prediksi_risiko', layout:{ 'line-join':'round', 'line-cap':'round' }, paint:{ 'line-width':1, 'line-opacity':0.95, 'line-color':[ 'match', ['get', 'risk_prediction'], 0,'#4caf50', 1,'#ffeb3b', 2,'#f44336', '#cccccc' ] }});
          setLayerInteractivity('prediksi_risiko-line'); applyVisibility(key); break;
        }
        case 'administrasi': {
          map.addSource('administrasi', { type:'geojson', data:filtered });
          const kecamatans = [...new Set(filtered.features.map(f => f.properties.nama_kec).filter(Boolean))];
          const colorExpression = ['match', ['get','nama_kec']];
          const colors = ['#e6194B','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe'];
          administrasiColorMap = {};
          kecamatans.forEach((kec,i)=>{ const color = colors[i%colors.length]; colorExpression.push(kec,color); administrasiColorMap[kec]=color; });
          colorExpression.push('rgba(0,0,0,0)');
          map.addLayer({ id:'administrasi-fill', type:'fill', source:'administrasi', paint:{ 'fill-color':colorExpression, 'fill-opacity':0.2 }});
          map.addLayer({ id:'administrasi-outline', type:'line', source:'administrasi', paint:{ 'line-color':'#fff', 'line-width':1.5 }});
          setLayerInteractivity('administrasi-fill'); applyVisibility(key); break;
        }
      }
    }catch(e){ console.error(`${key} load error`, e); }
  }
}
async function updateForSatwil(polygon){
  if (!map) return;
  addOrUpdateSatwilLayer(polygon);
  await loadAllDataLayers(polygon);
  // Panggil inisialisasi slider di sini
  renderLegend();
  updateDashboard();
  window.updateSearchIndex();
  try { map.fitBounds(turf.bbox(polygon), { padding:50, maxZoom:14 }); } catch(e){}
}
function renderLegend(){
  const body = document.getElementById('legend-content');
  // Diubah untuk mencari .tab-btn dan class .active
  const show = (id)=>document.querySelector(`.tab-btn[data-layer="${id}"]`)?.classList.contains('active');
  let html = '<h4>Legenda</h4>';

  if (show('troublespot')) { html += `<div class="legend-title">Troublespot</div>${legendRow('road-closed','Jalan Ditutup')}${legendRow('road-disturbance','Gangguan Jalan')}${legendRow('kemacetan','Titik Kemacetan')}${legendRow('kecelakaan','Kecelakaan')}`; }
  if (show('blackspot')) { html += `<div class="legend-title">Black Spot</div>${legendRow('blackspot','Black Spot')}`; }
  if (show('prediksi_risiko')) {
    html += `<div class="legend-title">Prediksi Risiko Kecelakaan</div>
      <div class="legend-item"><div style="width:100%; height:14px; border-radius:4px; background:linear-gradient(to right,#4caf50,#ffeb3b,#f44336)"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:11px;line-height:1.2;"><span>Rendah</span><span>Tinggi</span></div>`;
  }
  if (show('traffic')) {
    html += `<div class="legend-title">Kemacetan</div>
      <div class="legend-item"><div style="width:100%; height:14px; border-radius:4px; background:linear-gradient(to right,#ffeb3b,#f44336,#5d4037)"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:11px;line-height:1.2;"><span style="text-align:center;">Cukup Padat</span><span style="text-align:center;">Sangat Padat</span></div>`;
  }
  if (show('blacklink')) {
    html += `<div class="legend-title">Black Link</div>
      <div class="legend-item"><div class="legend-icon"><svg xmlns='http://www.w3.org/2000/svg' viewBox="0 0 30 10" width="36"><line x1="0" y1="5" x2="30" y2="5" stroke="#e53935" stroke-width="4"/><line x1="0" y1="5" x2="30" y2="5" stroke="#212121" stroke-width="2"/></svg></div><div class="legend-label">Blindspot</div></div>
      <div class="legend-item"><div class="legend-icon"><svg xmlns='http://www.w3.org/2000/svg' viewBox="0 0 30 10" width="36"><line x1="0" y1="5" x2="30" y2="5" stroke="#212121" stroke-width="4"/><line x1="0" y1="5" x2="30" y2="5" stroke="#e53935" stroke-width="2"/></svg></div><div class="legend-label">Tercover CCTV</div></div>`;
  }
  if (show('blackarea')) {
    html += `<div class="legend-title">Black Area</div>
      <div class="legend-item"><div class="legend-icon" style="background:rgba(192,192,192,0.5); border:1px solid #000; border-radius:50%; height:20px; width:20px;"></div><div class="legend-label">Area Rawan</div></div>`;
  }
  if (show('objek_vital')) {
    html += `<div class="legend-title">Objek Vital</div>
      ${legendRow('ov-plane','Bandara')} ${legendRow('ov-hospital','Faskes')}
      ${legendRow('ov-school','Pendidikan')} ${legendRow('ov-government','Pemerintahan')}
      ${legendRow('ov-police','Polisi')} ${legendRow('ov-train','Stasiun')}
      ${legendRow('ov-bus','Terminal')} ${legendRow('ov-pariwisata','Pariwisata')}
      ${legendRow('ov-port','Pelabuhan')}`; // BARU
  }
  if (show('cctv')) {
    html += `<div class="legend-title">CCTV</div> ${legendRow('cctv-on','Hidup')} ${legendRow('cctv-off','Mati')}`;
  }

  body.innerHTML = html.replace('<h4>Legenda</h4>', '') || '<div style="font-size:13px;color:#666">Tidak ada layer aktif.</div>';
}
function legendRow(iconId, label){
  const svg = ICON_SVGS[iconId] || '';
  return `<div class="legend-item"><div class="legend-icon"><img src="${'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg)}" alt="${label}" style="width:24px;height:24px"/></div><div class="legend-label">${label}</div></div>`;
}
function resetCanvas(id){
  const old = document.getElementById(id);
  if (!old) return null;
  const parent = old.parentNode;
  const next = document.createElement('canvas');
  next.id = id;
  parent.replaceChild(next, old);
  return next.getContext('2d');
}
function updateDashboard(filterDate = null) {
    // Bagian untuk grafik troublespot dan CCTV tidak berubah
    const ts = filteredLayerData.troublespot?.features ?? [];
    const cctv = filteredLayerData.cctv?.features ?? [];

    const tsCounts = ts.reduce((acc, f) => {
        const k = (f.properties?.keterangan || f.properties?.Keterangan || 'Lainnya') + '';
        acc[k] = (acc[k] || 0) + 1; return acc;
    }, {});
    const tsEntries = Object.entries(tsCounts).sort((a,b)=>b[1]-a[1]);
    if (troublespotChart) troublespotChart.destroy();
    const tsCtx = resetCanvas('troublespot-chart');
    if (tsCtx){
        troublespotChart = new Chart(tsCtx, {
            type:'bar', data:{ labels: tsEntries.map(([k])=>k), datasets:[{ label:'Jumlah', data: tsEntries.map(([,v])=>v), backgroundColor:'#e74c3c', borderColor:'#ffffff', borderWidth:1, barThickness:14 }] },
            options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true, ticks:{ precision:0, color:'#fff' }, grid:{ color:'rgba(255,255,255,0.2)' } }, y:{ ticks:{ font:{ size:11 }, color:'#fff' }, grid:{ color:'rgba(255,255,255,0.2)' } } } }
        });
    }
    const onCount = cctv.filter(f => normalizeCCTVStatus(f.properties)==='on').length;
    const offCount = cctv.filter(f => normalizeCCTVStatus(f.properties)==='off').length;
    if (cctvChart) cctvChart.destroy();
    const cctvCtx = resetCanvas('cctv-chart');
    if (cctvCtx){
        cctvChart = new Chart(cctvCtx, {
            type:'doughnut', data:{ labels:['Hidup','Mati'], datasets:[{ data:[onCount, offCount], backgroundColor:['#00e676','#e74c3c'], borderColor:'#ffffff', borderWidth:1 }] },
            options:{ responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{ legend:{ position:'bottom', labels:{ color:'#fff', boxWidth:10 } } } }
        });
    }

    // =================================================================
    // PERBAIKAN LOGIKA BARU UNTUK BLACK SPOT
    // =================================================================
    let bs = [];
    const masterBlackspots = timeSliderData.allFeatures.blackspot || [];

    // 1. Tentukan tanggal yang akan digunakan untuk filter
    let targetDate = filterDate; 
    if (!targetDate && timeSliderData.uniqueDates && timeSliderData.uniqueDates.length > 0) {
        // Jika tidak ada tanggal dari slider (pemuatan awal), gunakan tanggal terakhir dari data
        targetDate = timeSliderData.uniqueDates[timeSliderData.uniqueDates.length - 1];
    }

    // 2. Jika ada tanggal target, filter datanya. Jika tidak, 'bs' akan tetap kosong.
    if (targetDate) {
        const startTime = new Date(targetDate);
        startTime.setHours(0, 0, 0, 0);
        const endTime = new Date(targetDate);
        endTime.setHours(23, 59, 59, 999);
        
        bs = masterBlackspots.filter(f => {
            if (!f.properties.tanggal) return false;
            const featureDate = new Date(f.properties.tanggal);
            return featureDate >= startTime && featureDate <= endTime;
        });
    }
    
    // Bagian untuk merender daftar Top 5 Black Spot (tidak ada perubahan)
    const listEl = document.getElementById('blackspot-list');
    const noteEl = document.getElementById('blackspot-note');
    const wilayahName = (selectedPolygon?.properties?.Satwil ?? 'wilayah');
    if (!bs.length){
        listEl.innerHTML = `<div class="no-data-info">Tidak ada data black spot pada tanggal ini.</div>`;
        noteEl.textContent = '';
    } else {
        const parsed = bs.map(f=>({ f, skor: Number(f.properties?.SkorBS ?? 0), d: new Date(f.properties?.tanggal || 0) })).sort((a,b)=> b.skor - a.skor || b.d - a.d);
        listEl.innerHTML = parsed.slice(0,5).map(({f,skor})=>{
            const name = (f.properties?.Nama || f.properties?.Nm_Ruas || 'Black Spot') + '';
            return `<div class="blackspot-list-item"><span>${name.length > 30 ? name.slice(0, 27) + '...' : name}</span><span class="score">${skor}</span></div>`;
        }).join('');
        noteEl.textContent = parsed.length < 5 ? `Hanya ada ${parsed.length} Black Spot pada tanggal ini.` : '';
    }
}
</script>

<script>
/* =================== FUNGSI-FUNGSI TOOLS (VERSI FINAL LENGKAP) =================== */

// Fungsi untuk menampilkan popup secara terprogram (tidak berubah)
function showFeaturePopup(map, feature, coordinates) {
    if (popup && popup.isOpen()) popup.remove();
    const titleMap = {
        troublespot: 'Troublespot', blackspot: 'Black Spot', cctv: 'CCTV',
        objek_vital: 'Objek Vital', prediksi_risiko: 'Prediksi Risiko Kecelakaan',
        administrasi: 'Wilayah Administrasi', traffic: 'Kemacetan',
        blacklink: 'Black Link', blackarea: 'Black Area'
    };
    const layerId = feature.layer?.id || '';
    const prefix = Object.keys(titleMap).find(p => layerId.startsWith(p) || (feature.properties?._layerKey === p) );
    if (!prefix) return;
    let title = titleMap[prefix] || 'Informasi';
    if (prefix === 'objek_vital') {
        const ovLabel = OV_META[ovKeyFromKeterangan(feature.properties)]?.label || 'Lainnya';
        title = `Objek Vital • ${ovLabel}`;
    }
    let bodyHtml = '';
    for (const key in ALIAS_MAP) {
        if (feature.properties.hasOwnProperty(key)) {
            bodyHtml += `<div><strong>${ALIAS_MAP[key]}:</strong> ${feature.properties[key]}</div>`;
        }
    }
    if (bodyHtml === '') bodyHtml = '<div>Tidak ada informasi detail.</div>';
    const popupHtml = `<div class="popup-header">${title}</div><div class="popup-body">${bodyHtml}</div>`;
    popup.setLngLat(coordinates).setHTML(popupHtml).addTo(map);
}

/**
 * Memeriksa sebuah rute terhadap data troublespot & traffic yang ada. (VERSI FINAL DENGAN JARAK)
 * Mengembalikan array berisi alasan mengapa rute ini tidak disarankan.
 * @param {object} routeFeature - GeoJSON feature dari satu rute.
 * @returns {string[]} - Array berisi string peringatan, e.g., ['Jalan Ditutup', 'Kemacetan Parah']. Kosong jika aman.
 */
function checkRouteForHazards(routeFeature) {
    const hazardReasons = new Set();

    // 1. Periksa terhadap data Troublespot
    const troublespots = filteredLayerData.troublespot?.features || [];
    for (const spot of troublespots) {
        
        // =================================================================
        // PERUBAHAN UTAMA DI SINI: Menggunakan jarak, bukan persinggungan
        // =================================================================
        // Hitung jarak dari titik troublespot ke garis rute dalam meter
        const distanceToRoute = turf.pointToLineDistance(spot, routeFeature, { units: 'meters' });

        // Jika titik troublespot berada dalam jarak 15 meter dari garis rute, anggap itu relevan
        if (distanceToRoute < 15) { 
            const keter = (spot.properties?.keterangan ?? spot.properties?.Keterangan ?? spot.properties?.jenis_gangguan ?? spot.properties?.ket ?? '').toLowerCase().trim();
            
            if (keter === 'jalan ditutup') {
                hazardReasons.add("Jalan Ditutup");
            } else if (keter === 'kecelakaan') {
                hazardReasons.add("Kecelakaan");
            } else if (keter === 'titik kemacetan') {
                hazardReasons.add("Titik Kemacetan");
            }
        }
    }

    // 2. Periksa terhadap data Traffic Level 5 (Logika ini sudah benar, tidak perlu diubah)
    const trafficLines = filteredLayerData.traffic?.features || [];
    for (const line of trafficLines) {
        const level = Number(line.properties?.level ?? line.properties?.Level ?? line.properties?.tingkat_kepadatan ?? 0);

        if (level === 5) {
            if (turf.booleanIntersects(routeFeature, line)) {
                hazardReasons.add("Kemacetan Parah");
            }
        }
    }

    return Array.from(hazardReasons);
}

/**
 * Mengubah durasi dalam detik menjadi format string jam dan menit yang mudah dibaca.
 * @param {number} seconds - Durasi total dalam detik.
 * @returns {string} - String yang sudah diformat, e.g., "1 jam 24 mnt" atau "52 mnt".
 */
function formatDuration(seconds) {
    if (isNaN(seconds) || seconds < 0) return '- mnt';
    
    const totalMinutes = Math.round(seconds / 60);

    if (totalMinutes < 60) {
        return `${totalMinutes} mnt`;
    } else {
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;
        
        if (minutes === 0) {
            return `${hours} jam`;
        } else {
            return `${hours} jam ${minutes} mnt`;
        }
    }
}

/**
 * =================================================================
 * FUNGSI SMART SEARCH & ROUTING VERSI FINAL (REUSABLE)
 * =================================================================
 */
function initSearchAndRouting() {
    // --- Konfigurasi Awal ---
    const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjAxZjE5MGU1Nzk4OTRhZWRhM2Y3Nzk0YWQyZjE4ODZjIiwiaCI6Im11cm11cjY0In0=';
    
    // Ambil semua elemen input dan UI terkait
    const searchInput = document.getElementById('search-input');
    const fromInput = document.getElementById('from-input');
    const toInput = document.getElementById('to-input');
    const searchResultsEl = document.getElementById('search-results');
    const fromResultsEl = document.getElementById('from-results');
    const toResultsEl = document.getElementById('to-results');
    const routeControls = document.getElementById('route-controls');
    const btnToggleRoute = document.getElementById('btn-toggle-route');
    const clickPickToggle = document.getElementById('click-pick-toggle');
    const modeTabs = document.querySelectorAll('.mode-tab-btn');
    const routeBtn = document.getElementById('btn-route');
    const clearBtn = document.getElementById('btn-clear-route');
    const routeResultsBody = document.getElementById('route-results-body');
    const btnCollapse = document.getElementById('btn-collapse-route');
    const alertPopup = document.getElementById('route-alert-popup'); // ELEMEN BARU
    const btnSwap = document.getElementById('btn-swap-route');

    btnSwap.addEventListener('click', () => {
      // 1. Tukar data koordinat
      const tempCoord = fromCoord;
      fromCoord = toCoord;
      toCoord = tempCoord;

      // 2. Tukar nilai teks di input field
      const tempValue = fromInput.value;
      fromInput.value = toInput.value;
      toInput.value = tempValue;

      // 3. Hapus marker yang ada di peta
      if (fromMarker) fromMarker.remove();
      if (toMarker) toMarker.remove();

      // 4. Buat ulang marker di posisi baru sesuai data yang sudah ditukar
      if (fromCoord) {
        fromMarker = new maplibregl.Marker({ color: '#00ff66' }).setLngLat(fromCoord).addTo(map);
      } else {
        fromMarker = null;
      }

      if (toCoord) {
        toMarker = new maplibregl.Marker({ color: '#ff3333' }).setLngLat(toCoord).addTo(map);
      } else {
        toMarker = null;
      }
    });

    // Variabel state
    let fromCoord = null, toCoord = null;
    let fromMarker = null, toMarker = null;
    let activeField = null;
    let searchTimeout;
    let fuse;
    let searchResultMarker = null; // Variabel untuk pin hasil pencarian
    const routeSourceId = 'route-src';
    const routeLayerId = 'route-line';
    let routeResults = []; // Untuk menyimpan semua hasil GeoJSON rute
    
    // --- FUNGSI-FUNGSI INTI ---

    // Membangun index pencarian lokal dari data peta
    window.updateSearchIndex = () => {
        const searchConfig = {
            'cctv': ['nama_cctv', 'nama_jalan'],
            'blackspot': ['Nama', 'Nm_Ruas', 'Ket'],
            'objek_vital': ['Nama', 'Keterangan'],
            'troublespot': ['keterangan', 'street']
        };
        let searchableData = [];
        for (const [layerKey, propKeys] of Object.entries(searchConfig)) {
            if (filteredLayerData[layerKey] && filteredLayerData[layerKey].features) {
                filteredLayerData[layerKey].features.forEach(feature => {
                    let searchText = propKeys.map(key => feature.properties[key] || '').join(' ');
                    searchableData.push({ label: searchText.trim(), layerKey: layerKey, feature: feature });
                });
            }
        }
        fuse = new Fuse(searchableData, { keys: ['label'], includeScore: true, threshold: 0.4, minMatchCharLength: 3 });
    };

    // Menghubungi API Nominatim dengan penanganan error yang baik
    async function geocode(q) {
        const headers = { 'User-Agent': 'SmartTrafficApp/1.0 (contact@example.com)' };
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&countrycodes=ID&limit=5`, { headers });
            if (!res.ok) {
                console.error(`Nominatim request failed with status: ${res.status}`);
                return [];
            }
            const jsonData = await res.json();
            if (Array.isArray(jsonData)) {
                return jsonData.map(p => ({ label: p.display_name, coord: [+p.lon, +p.lat] }));
            } else {
                console.warn('Nominatim did not return an array:', jsonData);
                return [];
            }
        } catch (err) {
            console.error("Geocoding failed:", err);
            return [];
        }
    }

    // ✅ FUNGSI UTAMA YANG BISA DIGUNAKAN KEMBALI UNTUK SEMUA INPUT
    function attachCombinedSearch(inputEl, resultsEl, onPickCallback) {
        inputEl.addEventListener('input', e => {
            const query = e.target.value.trim();
            clearTimeout(searchTimeout);

            if (query.length < 3) {
                resultsEl.style.display = 'none';
                return;
            }
            resultsEl.style.display = 'block';
            resultsEl.innerHTML = '<div class="result-item" style="color:#888;">Mencari...</div>';

            searchTimeout = setTimeout(async () => {
                const localResultsPromise = fuse ? Promise.resolve(fuse.search(query).slice(0, 5)) : Promise.resolve([]);
                const globalResultsPromise = geocode(query);
                const [localResultsRaw, globalResultsRaw] = await Promise.all([localResultsPromise, globalResultsPromise]);

                const localResults = localResultsRaw.map(res => ({
                    label: res.item.label, type: 'Lokal', feature: res.item.feature, score: res.score
                }));
                const globalResults = globalResultsRaw.map(res => ({
                    label: res.label, type: 'Global', coord: res.coord, score: 0.5
                }));
                
                const combinedResults = [...localResults, ...globalResults]
                    .sort((a, b) => a.score - b.score)
                    .slice(0, 7);

                resultsEl.innerHTML = '';
                if (!combinedResults.length) {
                    resultsEl.innerHTML = '<div class="result-item" style="color:#888;">Tidak ada hasil.</div>';
                    return;
                }

                combinedResults.forEach(item => {
                    const d = document.createElement('div');
                    d.className = 'result-item';
                    const typeLabel = item.type === 'Lokal' ? `<span style="background:#e3f2fd; color:#1e88e5; font-size:10px; padding:2px 4px; border-radius:4px; font-weight:bold;">FITUR PETA</span>` : `<span style="background:#e8f5e9; color:#43a047; font-size:10px; padding:2px 4px; border-radius:4px; font-weight:bold;">LOKASI</span>`;
                    d.innerHTML = `${item.label} <div style="margin-top:4px;">${typeLabel}</div>`;
                    
                    d.onclick = () => {
                        resultsEl.style.display = 'none';
                        inputEl.value = item.label;
                        
                        let pickedItemData = { label: item.label };
                        if (item.type === 'Lokal') {
                            pickedItemData.coord = turf.centroid(item.feature).geometry.coordinates;
                            pickedItemData.feature = item.feature;
                        } else {
                            pickedItemData.coord = item.coord;
                        }
                        onPickCallback(pickedItemData);
                    };
                    resultsEl.appendChild(d);
                });
            }, 400);
        });
    }

    // --- PENERAPAN FUNGSI PENCARIAN KE SETIAP INPUT ---

    // 1. Terapkan ke Pencarian Utama
    attachCombinedSearch(searchInput, searchResultsEl, (pickedItem) => {
        // Hapus pin pencarian lama jika ada
        if (searchResultMarker) {
            searchResultMarker.remove();
        }
        
        // Pindahkan peta ke lokasi
        map.flyTo({ center: pickedItem.coord, zoom: 17 });
        
        // Tambahkan pin baru di lokasi hasil pencarian
        searchResultMarker = new maplibregl.Marker({ color: '#ffc107' }) // Warna kuning
            .setLngLat(pickedItem.coord)
            .addTo(map);

        // Tampilkan popup jika itu adalah fitur dari peta kita
        if (pickedItem.feature) {
            setTimeout(() => showFeaturePopup(map, pickedItem.feature, pickedItem.coord), 800);
        }
    });

    // 2. Terapkan ke Input "Lokasi Asal"
    attachCombinedSearch(fromInput, fromResultsEl, (pickedItem) => {
        setFrom(pickedItem.coord, pickedItem.label);
    });

    // 3. Terapkan ke Input "Lokasi Tujuan"
    attachCombinedSearch(toInput, toResultsEl, (pickedItem) => {
        setTo(pickedItem.coord, pickedItem.label);
    });

    // Sembunyikan dropdown jika klik di luar
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#search-routing-panel')) {
            searchResultsEl.style.display = 'none';
            fromResultsEl.style.display = 'none';
            toResultsEl.style.display = 'none';
        }
    });

    // --- FUNGSI-FUNGSI HELPER UNTUK RUTE (Lengkap dan Tanpa Perubahan) ---
    
    btnToggleRoute.addEventListener('click', () => {
        routeControls.classList.toggle('minimized');
        btnToggleRoute.textContent = routeControls.classList.contains('minimized') ? 'Buka' : 'Tutup';
    });

    document.getElementById('route-header').addEventListener('click', (e) => {
        if (e.target !== btnToggleRoute) btnToggleRoute.click();
    });

    modeTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            modeTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
        });
    });

    function setFrom(c, l) {
        fromCoord = c;
        fromInput.value = l || `${c[1].toFixed(5)},${c[0].toFixed(5)}`;
        if (fromMarker) fromMarker.remove();
        fromMarker = new maplibregl.Marker({ color: '#00ff66' }).setLngLat(c).addTo(map);
    }
    function setTo(c, l) {
        toCoord = c;
        toInput.value = l || `${c[1].toFixed(5)},${c[0].toFixed(5)}`;
        if (toMarker) toMarker.remove();
        toMarker = new maplibregl.Marker({ color: '#ff3333' }).setLngLat(c).addTo(map);
    }
    
    fromInput.addEventListener('focus', () => activeField = 'from');
    toInput.addEventListener('focus', () => activeField = 'to');

    map.on('click', e => {
        if (!clickPickToggle.checked) return;
        const c = [e.lngLat.lng, e.lngLat.lat];
        if (activeField === 'from' || !fromCoord) {
            setFrom(c);
            activeField = 'to';
        } else {
            setTo(c);
        }
    });
    
    function parseLatLng(t) {
        const m = t.match(/(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)/);
        if (!m) return null;
        return [+m[3], +m[1]];
    }
    fromInput.addEventListener('change', () => { const c = parseLatLng(fromInput.value); if (c) setFrom(c); });
    toInput.addEventListener('change', () => { const c = parseLatLng(toInput.value); if (c) setTo(c); });

    function getRelevantAvoidanceCauses(startCoord, endCoord) {
        const causes = new Set();
        const featuresToAvoid = [];

        // Buat Bounding Box di sekitar titik awal dan akhir dengan buffer
        const routeLine = turf.lineString([startCoord, endCoord]);
        const routeBbox = turf.bbox(routeLine);
        // Buffer bbox untuk menangkap fitur di sekitar rute lurus
        const areaOfInterest = turf.buffer(turf.bboxPolygon(routeBbox), 2, { units: 'kilometers' });

        // 1. Cek Troublespots
        const tsFC = filteredLayerData?.troublespot || { features: [] };
        (tsFC.features || []).forEach(f => {
            // Hanya periksa fitur yang ada di area relevan
            if (!turf.booleanIntersects(f, areaOfInterest)) return;

            const keter = (f.properties?.keterangan || '').toLowerCase().trim();
            let causeText = null;
            if (keter === 'jalan ditutup') causeText = 'jalan ditutup';
            else if (keter === 'titik kemacetan') causeText = 'titik kemacetan';
            else if (keter === 'kecelakaan') causeText = 'Kecelakaan';

            if (causeText) {
                featuresToAvoid.push(f);
                causes.add(causeText);
            }
        });

        // 2. Cek Lalu Lintas Sangat Padat (Level 5)
        const trFC = filteredLayerData?.traffic || { features: [] };
        (trFC.features || []).forEach(f => {
            if (Number(f.properties?.level) === 5) {
                if (turf.booleanIntersects(f, areaOfInterest)) {
                    featuresToAvoid.push(f);
                    causes.add('kemacetan parah');
                }
            }
        });

        if (featuresToAvoid.length === 0) {
            return { avoidPolygons: null, causes: [] };
        }

        // Buat MultiPolygon untuk dikirim ke ORS
        const polys = [];
        for (const feat of featuresToAvoid) {
            try {
                const buffered = turf.buffer(feat, 25, { units: 'meters' }); // buffer 25m
                if (buffered.geometry.type === 'Polygon') polys.push(buffered.geometry.coordinates);
                else if (buffered.geometry.type === 'MultiPolygon') polys.push(...buffered.geometry.coordinates);
            } catch {}
        }

        const avoidMultiPolygon = polys.length > 0 ? { type: 'MultiPolygon', coordinates: polys } : null;

        return {
            avoidPolygons: avoidMultiPolygon,
            causes: Array.from(causes)
        };
    }

    function estimateDelaySeconds(routeGeoJSON, mode) {
        if (mode === 'foot') return { seconds: 0, note: 'Pejalan kaki tidak terpengaruh kemacetan.' };
        const trFC = filteredLayerData?.traffic || { features: [] };
        let total = 0;
        for (const seg of (trFC.features || [])) {
            try {
                if ((turf.lineIntersect(routeGeoJSON, seg)?.features?.length || 0) > 0) {
                    total += Number(seg.properties?.delay) || 120;
                }
            } catch {}
        }
        return { seconds: total, note: 'Estimasi berdasarkan tingkat kemacetan di jalan.' };
    }

    function formatDelay(sec) {
        if (sec <= 0) return 'Tidak ada estimasi delay.';
        const m = Math.floor(sec / 60), s = sec % 60;
        return m > 0 ? `Estimasi Delay: ${m} menit ${s} detik` : `Estimasi Delay: ${s} detik`;
    }

    // FUNGSI BARU 1: Fungsi utama yang dirombak
    async function drawRoute() {
        if (!fromCoord || !toCoord) return alert('Isi lokasi awal dan akhir terlebih dahulu.');

        alertPopup.style.display = 'none';
        routeResults = [];
        document.getElementById('route-options-container').innerHTML = '';
        routeResultsBody.innerHTML = 'Menghitung rute...';
        document.getElementById('route-results').style.display = 'block';

        const activeModeTab = document.querySelector('.mode-tab-btn.active');
        const uiMode = activeModeTab ? activeModeTab.dataset.mode : 'car';
        let orsProfile;
        switch (uiMode) {
            case 'car': orsProfile = 'driving-car'; break;
            case 'bicycle': orsProfile = 'cycling-regular'; break;
            case 'foot': orsProfile = 'foot-walking'; break;
        }

        const avoidanceData = (uiMode === 'foot') ? { avoidPolygons: null, causes: [] } : getRelevantAvoidanceCauses(fromCoord, toCoord);
        const headers = { 'Accept': 'application/json, application/geo+json', 'Content-Type': 'application/json', 'Authorization': ORS_API_KEY };
        const url = `https://api.openrouteservice.org/v2/directions/${orsProfile}/geojson`;

        const smartRouteBody = { 
            coordinates: [fromCoord, toCoord], 
            language: 'id',
            alternative_routes: { target_count: 2, weight_factor: 1.5 }
        };
        if (avoidanceData.avoidPolygons) {
            smartRouteBody.options = { avoid_polygons: avoidanceData.avoidPolygons };
        }
        const smartRoutePromise = fetch(url, { method: 'POST', headers, body: JSON.stringify(smartRouteBody) }).then(res => res.json());

        const directRouteBody = { coordinates: [fromCoord, toCoord], language: 'id' };
        const directRoutePromise = (uiMode !== 'foot' && avoidanceData.causes.length > 0) 
            ? fetch(url, { method: 'POST', headers, body: JSON.stringify(directRouteBody) }).then(res => res.json())
            : Promise.resolve(null);

        try {
            const [smartResult, directResult] = await Promise.all([smartRoutePromise, directRoutePromise]);

            const uniqueGeometries = new Set();
            let taggedFeatures = [];

            if (smartResult && smartResult.features) {
                smartResult.features.forEach(feat => {
                    const geomString = JSON.stringify(feat.geometry.coordinates);
                    if (!uniqueGeometries.has(geomString)) {
                        uniqueGeometries.add(geomString);
                        taggedFeatures.push({ type: 'smart', feature: feat });
                    }
                });
            }
            if (directResult && directResult.features) {
                directResult.features.forEach(feat => {
                    const geomString = JSON.stringify(feat.geometry.coordinates);
                    if (!uniqueGeometries.has(geomString)) {
                        uniqueGeometries.add(geomString);
                        taggedFeatures.push({ type: 'direct', feature: feat });
                    }
                });
            }

            if (taggedFeatures.length === 0) throw new Error("Tidak ada rute yang ditemukan.");

            let finalSortedTaggedFeatures;
            const wasAvoidanceActive = uiMode !== 'foot' && avoidanceData.causes.length > 0;

            if (wasAvoidanceActive) {
                const smartRoutes = taggedFeatures
                    .filter(tf => tf.type === 'smart')
                    .sort((a, b) => a.feature.properties.summary.duration - b.feature.properties.summary.duration);

                const directRoutes = taggedFeatures
                    .filter(tf => tf.type === 'direct')
                    .sort((a, b) => a.feature.properties.summary.duration - b.feature.properties.summary.duration);

                finalSortedTaggedFeatures = [...smartRoutes, ...directRoutes];
            } else {
                finalSortedTaggedFeatures = taggedFeatures
                    .sort((a, b) => a.feature.properties.summary.duration - b.feature.properties.summary.duration);
            }

            // PERUBAHAN DI SINI: Simpan hasil bersama 'tag' tipenya
            routeResults = finalSortedTaggedFeatures;

            renderRouteOptions();
            displayRoute(0);

            // =========================================================
            // PENAMBAHAN DI SINI: Zoom ke semua rute yang ditemukan
            // =========================================================
            try {
                // Buat FeatureCollection dari semua geometri rute yang unik
                const allRoutesCollection = turf.featureCollection(
                    routeResults.map(taggedRoute => taggedRoute.feature)
                );
                // Hitung bounding box gabungan dari semua rute
                const bbox = turf.bbox(allRoutesCollection);
                // Lakukan zoom ke area bounding box tersebut dengan sedikit padding
                map.fitBounds(bbox, { padding: 60, maxZoom: 16 });
            } catch (e) {
                console.error("Gagal melakukan zoom ke rute:", e);
            }

        } catch (e) {
            console.error("Gagal mendapatkan rute:", e);
            routeResultsBody.innerHTML = `<div style="color:#ffcdd2; padding: 4px;">Gagal menghitung rute: ${e.message}</div>`;
        }
    }

    // FUNGSI BARU 2: Untuk menampilkan tombol-tombol pilihan rute
    function renderRouteOptions() {
        const container = document.getElementById('route-options-container');
        container.innerHTML = '';
        // PERUBAHAN DI SINI: Akses '.feature' untuk mendapatkan data rute
        routeResults.forEach((taggedRoute, index) => { 
            const feat = taggedRoute.feature; // Ambil data feature dari dalam objek
            const summary = feat.properties.summary;
            const distKm = (summary.distance / 1000).toFixed(1);
            const durationText = formatDuration(summary.duration);

            const btn = document.createElement('button');
            btn.className = 'route-option-btn';
            btn.dataset.index = index;
            btn.innerHTML = `<b>Opsi Rute ${index + 1}: ${durationText}</b> <span>(${distKm} km)</span>`;
            
            btn.onclick = () => {
                displayRoute(index);
            };

            container.appendChild(btn);
        });
    }

    // FUNGSI BARU 3: Untuk menampilkan rute yang dipilih di peta dan panel
    function displayRoute(selectedIndex) {
        if (!routeResults[selectedIndex]) return;

        // Ambil objek rute dan data feature-nya
        const selectedTaggedRoute = routeResults[selectedIndex];
        const feat = selectedTaggedRoute.feature;

        // Bagian menggambar ulang rute di peta (tidak ada perubahan di blok ini)
        if (map.getLayer(routeLayerId)) map.removeLayer(routeLayerId);
        if (map.getLayer('route-line-inactive')) map.removeLayer('route-line-inactive');
        if (map.getSource(routeSourceId)) map.removeSource(routeSourceId);

        const routeCollection = {
            type: 'FeatureCollection',
            features: routeResults.map((taggedRoute, index) => ({
                ...taggedRoute.feature,
                properties: { ...taggedRoute.feature.properties, route_index: index }
            }))
        };
        
        map.addSource(routeSourceId, { type: 'geojson', data: routeCollection });
        map.addLayer({
            id: 'route-line-inactive', type: 'line', source: routeSourceId,
            paint: { 'line-width': 4, 'line-color': '#2196f3', 'line-opacity': 0.3 },
            filter: ['!=', 'route_index', selectedIndex]
        });
        map.addLayer({
            id: routeLayerId, type: 'line', source: routeSourceId,
            paint: { 'line-width': 6, 'line-color': '#2196f3' },
            filter: ['==', 'route_index', selectedIndex]
        });

        // Update status 'active' pada tombol (tidak ada perubahan di blok ini)
        document.querySelectorAll('.route-option-btn').forEach(btn => {
            btn.classList.toggle('active', parseInt(btn.dataset.index) === selectedIndex);
        });

        // Ambil data untuk ditampilkan
        const uiMode = document.querySelector('.mode-tab-btn.active')?.dataset.mode || 'car';
        const distKm = (feat.properties.summary.distance / 1000).toFixed(2);
        const durationText = formatDuration(feat.properties.summary.duration);

        // =======================================================================
        // PERBAIKAN DI SINI: Tambahkan pengecekan untuk mode 'Jalan Kaki'
        // =======================================================================
        let finalMessage = '';
        const hazards = checkRouteForHazards(feat);

        // HANYA tampilkan peringatan "Rute Tidak Disarankan" jika mode BUKAN 'jalan kaki'
        if (uiMode !== 'foot' && hazards.length > 0) {
            let reasonText = (hazards.length === 1) ? hazards[0] : (hazards.length === 2) ? `${hazards[0]} dan ${hazards[1]}` : `${hazards.slice(0, -1).join(', ')}, dan ${hazards.slice(-1)}`;
            finalMessage = `<div style="font-weight: bold; color: #d32f2f;">Rute Tidak Disarankan Karena ${reasonText}.</div>`;
        } else {
            // Jika mode 'jalan kaki' ATAU jika rute aman, tampilkan estimasi delay normal
            const delayInfo = estimateDelaySeconds({ type: 'Feature', geometry: feat.geometry }, uiMode);
            const delayText = formatDelay(delayInfo.seconds);
            finalMessage = `<b>${delayText}</b>`;
            if (delayInfo.note) finalMessage += `<br><small>${delayInfo.note}</small>`;
        }
        
        // Tampilkan detail petunjuk arah
        let html = `<b>Jarak:</b> ${distKm} km<br><b>Waktu Tempuh:</b> ${durationText}<br>`;
        html += finalMessage; // Sisipkan pesan yang sudah kita buat
        html += `<hr><b>Petunjuk arah:</b><br>`;
        (feat.properties.segments[0]?.steps || []).forEach((s, i) => {
            html += `${i + 1}. ${s.instruction} (${(s.distance / 1000).toFixed(2)} km)<br>`;
        });
        routeResultsBody.innerHTML = html;

        // Logika untuk menampilkan alert pengalihan rute (tidak ada perubahan di blok ini)
        const avoidanceData = getRelevantAvoidanceCauses(fromCoord, toCoord);
        const directRoute = routeResults.find(r => r.type === 'direct');
        
        if (avoidanceData.causes.length > 0 && selectedTaggedRoute.type === 'smart' && directRoute && feat.properties.summary.duration > directRoute.feature.properties.summary.duration) {
            let message = 'Rute ini dialihkan karena ' + avoidanceData.causes.join(', ') + '.';
            alertPopup.innerHTML = `<span>${message}</span><button class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>`;
            alertPopup.style.display = 'block';
        } else {
            alertPopup.style.display = 'none';
        }
    }

    routeBtn.onclick = drawRoute;
    clearBtn.onclick = () => {
        // Hapus layer rute dari peta
        if (map.getLayer(routeLayerId)) map.removeLayer(routeLayerId);
        if (map.getLayer('route-line-inactive')) map.removeLayer('route-line-inactive');
        if (map.getSource(routeSourceId)) map.removeSource(routeSourceId);

        // Kosongkan panel hasil
        routeResultsBody.innerHTML = '';
        document.getElementById('route-options-container').innerHTML = '';
        document.getElementById('route-results').style.display = 'none';

        // Hapus marker dan data
        if (fromMarker) { fromMarker.remove(); fromMarker = null; }
        if (toMarker) { toMarker.remove(); toMarker = null; }
        if (searchResultMarker) { searchResultMarker.remove(); searchResultMarker = null; }

        searchInput.value = '';
        fromCoord = toCoord = null;
        fromInput.value = '';
        toInput.value = '';

        routeResults = []; // Kosongkan array hasil
        alertPopup.style.display = 'none'; // Sembunyikan alert
    };
    btnCollapse.onclick = () => {
        const wrap = document.getElementById('route-results');
        wrap.classList.toggle('collapsed');
        btnCollapse.textContent = wrap.classList.contains('collapsed') ? 'Buka' : 'Tutup';
    };
}

/**
 * ================================================
 * FUNGSI PENGUKURAN (MEASUREMENT) - Lengkap dan Tanpa Perubahan
 * ================================================
 */
function initMeasureTools(map) {
    const measurePanel = document.getElementById('measure-panel');
    const toggleBtn = document.getElementById('measure-toggle-btn');
    const btnDist = document.getElementById('btn-measure-dist');
    const btnArea = document.getElementById('btn-measure-area');
    const btnClear = document.getElementById('btn-measure-clear');
    const resultEl = document.getElementById('measure-result');
    const togglePanel = () => {
        const isMinimized = measurePanel.classList.toggle('minimized');
        toggleBtn.textContent = isMinimized ? '+' : '−';
    };
    toggleBtn.onclick = togglePanel;
    document.getElementById('measure-header').onclick = (e) => {
        if (e.target.closest('#measure-header') && e.target.tagName !== 'BUTTON') {
            togglePanel();
        }
    };
    let activeTool = null;
    let geojson = { type: 'FeatureCollection', features: [] };
    const sourceId = 'measure-source';
    map.addSource(sourceId, { type: 'geojson', data: geojson });
    map.addLayer({ id: 'measure-points', type: 'circle', source: sourceId, paint: { 'circle-radius': 5, 'circle-color': '#fff', 'circle-stroke-color': '#000', 'circle-stroke-width': 2 }, filter: ['in', '$type', 'Point'] });
    map.addLayer({ id: 'measure-lines', type: 'line', source: sourceId, layout: { 'line-cap': 'round', 'line-join': 'round' }, paint: { 'line-color': '#ffc107', 'line-width': 3, 'line-dasharray': [2, 2] }, filter: ['in', '$type', 'LineString'] });
    map.addLayer({ id: 'measure-poly', type: 'fill', source: sourceId, paint: { 'fill-color': '#ffc107', 'fill-opacity': 0.3 }, filter: ['in', '$type', 'Polygon'] });
    const updateSource = () => map.getSource(sourceId).setData(geojson);
    const clearMeasure = () => {
        if (activeTool) {
            document.getElementById(`btn-measure-${activeTool}`).classList.remove('active');
        }
        activeTool = null;
        geojson.features = [];
        updateSource();
        map.getCanvas().style.cursor = '';
        resultEl.textContent = 'Pilih tool untuk mulai';
        map.off('click', handleMapClick);
        map.off('dblclick', handleMapDblClick);
    };
    const handleMapClick = (e) => {
        const coords = [e.lngLat.lng, e.lngLat.lat];
        const points = geojson.features.filter(f => f.geometry.type === 'Point');
        points.push({ type: 'Feature', geometry: { type: 'Point', coordinates: coords } });
        geojson.features = [...points];
        if (activeTool === 'dist') {
            if (points.length > 1) {
                const line = turf.lineString(points.map(p => p.geometry.coordinates));
                const len = turf.length(line, { units: 'kilometers' });
                resultEl.textContent = `Jarak: ${len.toFixed(2)} km`;
                geojson.features.push(line);
            }
        } else if (activeTool === 'area') {
            if (points.length > 2) {
                const polyCoords = points.map(p => p.geometry.coordinates);
                polyCoords.push(points[0].geometry.coordinates);
                const polygon = turf.polygon([polyCoords]);
                const area = turf.area(polygon);
                resultEl.textContent = `Luas: ${(area / 1000000).toFixed(3)} km²`;
                geojson.features.push(polygon);
            } else {
                resultEl.textContent = 'Klik min. 3 titik...';
            }
        }
        updateSource();
    };
    const handleMapDblClick = () => {
        const points = geojson.features.filter(f => f.geometry.type === 'Point');
        if ((activeTool === 'area' && points.length > 2) || (activeTool === 'dist' && points.length > 1)) {
            map.getCanvas().style.cursor = '';
            map.off('click', handleMapClick);
            map.off('dblclick', handleMapDblClick);
        }
    };
    const startMeasure = (tool) => {
        if (activeTool === tool) return clearMeasure();
        clearMeasure();
        activeTool = tool;
        if (measurePanel.classList.contains('minimized')) togglePanel();
        document.getElementById(`btn-measure-${tool}`).classList.add('active');
        map.getCanvas().style.cursor = 'crosshair';
        resultEl.textContent = 'Klik di peta. Dobel-klik untuk selesai.';
        map.on('click', handleMapClick);
        map.on('dblclick', handleMapDblClick);
    };
    btnDist.onclick = () => startMeasure('dist');
    btnArea.onclick = () => startMeasure('area');
    btnClear.onclick = clearMeasure;
}

</script>
</body>
</html>